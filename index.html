<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä»‹è­·è¨˜éŒ² ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --blue:#2563eb;--blue2:#1d4ed8;--bluebg:#eff6ff;
  --green:#16a34a;--greenbg:#f0fdf4;
  --red:#dc2626;--redbg:#fef2f2;
  --yellow:#d97706;--yellowbg:#fffbeb;
  --gray:#6b7280;--graybg:#f9fafb;--border:#e5e7eb;
  --radius:12px;--shadow:0 2px 16px rgba(0,0,0,.08);
}
body{font-family:'Hiragino Kaku Gothic Pro','ãƒ¡ã‚¤ãƒªã‚ª',sans-serif;background:#f1f5f9;color:#1e293b;min-height:100vh;}

/* ===== PINç”»é¢ ===== */
#pin-screen{
  position:fixed;inset:0;z-index:9999;
  background:linear-gradient(135deg,#1e3a5f 0%,#2563eb 100%);
  display:flex;align-items:center;justify-content:center;
}
.pin-card{background:#fff;border-radius:20px;padding:36px 32px;width:320px;text-align:center;box-shadow:0 12px 48px rgba(0,0,0,.25);}
.pin-card h2{font-size:20px;font-weight:800;margin:12px 0 4px;}
.pin-card .sub{font-size:12px;color:#64748b;margin-bottom:6px;}
.pin-hint-box{background:#fef9c3;border:1.5px solid #fde047;border-radius:8px;padding:8px 12px;font-size:13px;font-weight:700;color:#854d0e;margin-bottom:20px;}
.dots{display:flex;justify-content:center;gap:14px;margin-bottom:22px;}
.dot{width:16px;height:16px;border-radius:50%;background:#e2e8f0;transition:.15s;}
.dot.on{background:#2563eb;transform:scale(1.1);}
.numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.numpad button{padding:15px;border:2px solid #e2e8f0;border-radius:10px;font-size:20px;font-weight:700;background:#f8faff;cursor:pointer;transition:.15s;color:#1e293b;}
.numpad button:hover{background:#dbeafe;border-color:#93c5fd;}
.numpad button:active{transform:scale(.93);}
.numpad .del{background:#fef2f2;border-color:#fecaca;color:#dc2626;font-size:16px;}
.pin-err{color:#dc2626;font-size:13px;font-weight:600;min-height:18px;margin-top:10px;}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-10px)}75%{transform:translateX(10px)}}
.shake{animation:shake .35s ease;}

/* ===== NAV ===== */
nav{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;box-shadow:0 2px 12px rgba(37,99,235,.3);position:sticky;top:0;z-index:100;}
.nav-in{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:0 14px;flex-wrap:nowrap;gap:6px;min-height:52px;}
.brand{display:flex;align-items:center;gap:0;padding:10px 0;white-space:nowrap;flex-shrink:0;}
.brand-icon{display:none;}
.brand h1{font-size:14px;font-weight:800;line-height:1.2;white-space:nowrap;}
.brand p{font-size:10px;opacity:.8;margin-top:1px;white-space:nowrap;}
.nav-btns{display:flex;gap:2px;flex-wrap:nowrap;}
.nav-btn{padding:6px 10px;border-radius:7px;cursor:pointer;font-size:11.5px;font-weight:600;color:rgba(255,255,255,.75);border:none;background:transparent;transition:.2s;white-space:nowrap;}
.nav-btn:hover{background:rgba(255,255,255,.15);color:#fff;}
.nav-btn.on{background:rgba(255,255,255,.22);color:#fff;}
.lock-btn{padding:6px 10px;border-radius:7px;background:rgba(255,255,255,.15);color:#fff;border:1.5px solid rgba(255,255,255,.35);font-size:11.5px;cursor:pointer;font-weight:600;white-space:nowrap;}
.lock-btn:hover{background:rgba(255,255,255,.25);}

/* ===== PAGE ===== */
.page{display:none;max-width:1100px;margin:24px auto;padding:0 16px;}
.page.on{display:block;}

/* ===== CARD ===== */
.card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin-bottom:18px;}
.card-title{font-size:14px;font-weight:700;color:var(--blue);margin-bottom:16px;padding-bottom:10px;border-bottom:2px solid var(--bluebg);display:flex;align-items:center;gap:7px;}

/* ===== FORM ===== */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
.full{grid-column:1/-1;}
.fg{display:flex;flex-direction:column;gap:4px;}
label{font-size:12px;font-weight:600;color:#475569;}
input,select,textarea{border:1.5px solid var(--border);border-radius:8px;padding:9px 11px;font-size:13px;font-family:inherit;background:#fafafa;transition:.2s;}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--blue);background:#fff;box-shadow:0 0 0 3px rgba(37,99,235,.07);}
textarea{resize:vertical;min-height:68px;}

/* ===== INPUT TAB ===== */
.itabs{display:flex;gap:6px;margin-bottom:16px;}
.itab{padding:8px 18px;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;border:2px solid var(--border);color:var(--gray);background:#fff;transition:.2s;}
.itab.on{border-color:var(--blue);color:var(--blue);background:var(--bluebg);}
.ipane{display:none;}
.ipane.on{display:block;}

/* ===== BUTTONS ===== */
.btn{border:none;border-radius:9px;padding:10px 18px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;display:inline-flex;align-items:center;gap:6px;transition:.2s;}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.12);}
.btn:active{transform:translateY(0);}
.bp{background:var(--blue);color:#fff;}
.bp:hover{background:var(--blue2);}
.bs{background:var(--green);color:#fff;}
.bd{background:var(--red);color:#fff;}
.bo{background:#fff;color:var(--blue);border:2px solid var(--blue);}
.bg{background:#f1f5f9;color:#475569;}
.brow{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;}

/* ===== VOICE ===== */
.voice-wrap{background:#fff5f5;border:2px dashed #fca5a5;border-radius:10px;padding:14px;margin-bottom:14px;}
.voice-wrap p{font-size:12px;color:#991b1b;font-weight:600;margin-bottom:8px;}
.rec-ind{display:none;align-items:center;gap:7px;margin-top:8px;font-size:12px;color:var(--red);}
.rec-dot{width:10px;height:10px;border-radius:50%;background:var(--red);animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.2;}}

/* éŸ³å£°å…¥åŠ›ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ */
.voice-check{background:#f0fdf4;border:1.5px solid #86efac;border-radius:8px;padding:10px 14px;margin-top:10px;font-size:11px;}
.voice-check strong{font-size:12px;color:#15803d;display:block;margin-bottom:6px;}
.vc-items{display:flex;flex-wrap:wrap;gap:5px;}
.vci{padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;}
.vci.ok{background:#dcfce7;color:#15803d;}
.vci.ng{background:#fee2e2;color:#dc2626;}
.vci.na{background:#f1f5f9;color:#94a3b8;}

/* ===== OUTPUT ===== */
.out-box{background:#f8faff;border:1.5px solid #bfdbfe;border-radius:10px;padding:18px;font-size:13px;line-height:2;white-space:pre-wrap;min-height:80px;display:none;}
.out-box.on{display:block;}
.out-empty{text-align:center;padding:28px;color:#94a3b8;font-size:13px;}

/* ===== VITAL CHIPS ===== */
.vc{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;margin:2px;}
.vc-r{background:var(--redbg);color:var(--red);}
.vc-y{background:var(--yellowbg);color:var(--yellow);}
.vc-g{background:var(--greenbg);color:var(--green);}

/* ===== STATS ===== */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:18px;}
.stat{background:#fff;border-radius:var(--radius);padding:18px;text-align:center;box-shadow:var(--shadow);}
.stat .n{font-size:32px;font-weight:800;color:var(--blue);}
.stat .l{font-size:11px;color:var(--gray);margin-top:3px;}
.stat .s{font-size:11px;color:#94a3b8;margin-top:2px;}

/* ===== TABLE ===== */
.twrap{overflow-x:auto;border-radius:10px;border:1.5px solid var(--border);}
table{width:100%;border-collapse:collapse;font-size:12.5px;}
thead{background:var(--bluebg);}
th{padding:10px 13px;text-align:left;font-weight:700;color:var(--blue);white-space:nowrap;}
tbody tr{border-top:1px solid var(--border);transition:background .1s;}
tbody tr:hover{background:#f8faff;}
td{padding:10px 13px;vertical-align:middle;}
.tag{display:inline-block;padding:2px 9px;border-radius:20px;font-size:11px;font-weight:600;}
.tbl{background:#dbeafe;color:#1d4ed8;}
.tgr{background:#dcfce7;color:#15803d;}
.tyl{background:#fef9c3;color:#a16207;}
.trd{background:#fee2e2;color:#dc2626;}

/* ===== FILTER ===== */
.frow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center;}
.frow input,.frow select{padding:8px 11px;font-size:13px;border-radius:8px;border:1.5px solid var(--border);font-family:inherit;}
.frow input:focus,.frow select:focus{outline:none;border-color:var(--blue);}

/* ===== MODAL ===== */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:500;align-items:center;justify-content:center;}
.modal-bg.on{display:flex;}
.modal{background:#fff;border-radius:16px;padding:26px;max-width:600px;width:92%;max-height:82vh;overflow-y:auto;box-shadow:0 8px 40px rgba(0,0,0,.18);}
.modal h3{font-size:15px;font-weight:700;color:var(--blue);margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid var(--bluebg);}
.modal pre{font-size:12.5px;line-height:1.9;white-space:pre-wrap;font-family:inherit;}

/* ===== SETUP ===== */
.step{display:flex;gap:14px;margin-bottom:18px;padding:16px;background:var(--graybg);border-radius:10px;border:1.5px solid var(--border);}
.snum{min-width:30px;height:30px;border-radius:50%;background:var(--blue);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px;}
.step h3{font-size:13px;font-weight:700;margin-bottom:3px;}
.step p{font-size:12px;color:#475569;line-height:1.7;}
.codebox{background:#1e293b;color:#7dd3fc;border-radius:8px;padding:13px;font-family:monospace;font-size:11.5px;line-height:1.8;margin-top:8px;overflow-x:auto;}

/* ===== LOADING ===== */
.loading{display:none;align-items:center;gap:8px;font-size:13px;color:var(--blue);margin-top:10px;}
.loading.on{display:flex;}
.spin{width:16px;height:16px;border:2.5px solid var(--bluebg);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* ===== TOAST ===== */
.toast{position:fixed;bottom:24px;right:24px;z-index:9000;background:#1e293b;color:#fff;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,.2);display:none;align-items:center;gap:8px;}
.toast.on{display:flex;animation:up .3s ease;}
@keyframes up{from{transform:translateY(16px);opacity:0;}to{transform:translateY(0);opacity:1;}}

/* ===== SETTINGS PAGE ===== */
.settings-section{margin-bottom:22px;}
.settings-section .sec-title{font-size:13px;font-weight:700;color:var(--blue);margin-bottom:12px;padding-bottom:6px;border-bottom:2px solid var(--bluebg);display:flex;align-items:center;gap:6px;}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px;}
.setting-row:last-child{border-bottom:none;}
.setting-label{font-size:13px;font-weight:600;}
.setting-desc{font-size:11px;color:#94a3b8;margin-top:2px;}
.setting-control select,.setting-control input[type=text]{padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;background:#fff;}
.setting-control input[type=text]{width:180px;}
.toggle-wrap{display:flex;align-items:center;gap:8px;}
.toggle{position:relative;width:44px;height:24px;display:inline-block;flex-shrink:0;}
.toggle input{opacity:0;width:100%;height:100%;position:absolute;left:0;top:0;cursor:pointer;z-index:3;margin:0;}
.toggle-slider{position:absolute;inset:0;background:#cbd5e1;border-radius:24px;cursor:pointer;transition:.3s;z-index:1;}
.toggle-slider:before{content:'';position:absolute;width:18px;height:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.3s;z-index:2;}
.toggle input:checked + .toggle-slider{background:var(--blue);}
.toggle input:checked + .toggle-slider:before{transform:translateX(20px);}
.setting-control label.toggle{cursor:pointer;}
.admin-badge{display:inline-flex;align-items:center;gap:4px;background:#fef3c7;color:#b45309;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;}
/* è‡ªå‹•ãƒ­ãƒƒã‚¯ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è­¦å‘Š */
#auto-lock-warning{display:none;position:fixed;top:70px;right:16px;z-index:800;background:#fef3c7;border:2px solid #d97706;border-radius:12px;padding:12px 18px;font-size:13px;font-weight:700;color:#92400e;box-shadow:0 4px 16px rgba(0,0,0,.15);animation:up .3s ease;}
#auto-lock-warning .alw-close{cursor:pointer;margin-left:12px;color:#92400e;font-size:16px;}
/* ===== RESPONSIVE ===== */
@media(max-width:680px){
  .g2,.g3,.stats{grid-template-columns:1fr;}
  .full{grid-column:1;}
  .nav-btns{display:flex;flex-wrap:nowrap;overflow-x:auto;}
  .nav-btn{font-size:10px;padding:5px 7px;}
  .stats{grid-template-columns:1fr 1fr;}
  .setting-row{flex-direction:column;align-items:flex-start;}
}
</style>
</head>
<body>

<!-- ===== PINãƒ­ãƒƒã‚¯ç”»é¢ ===== -->
<div id="pin-screen">
  <div class="pin-card" id="pin-card" style="width:340px;padding:30px 28px;">
    <h2 style="font-size:18px;font-weight:800;color:#1e3a5f;margin-bottom:4px;">ä»‹è­·è¨˜éŒ² ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h2>

    <!-- STEP 1: æ‹…å½“è€…é¸æŠ -->
    <div id="pin-step1">
      <p class="sub" style="margin-bottom:16px;">ã‚ãªãŸã®åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
      <div id="pin-staff-list" style="max-height:260px;overflow-y:auto;text-align:left;"></div>
      <p style="font-size:11px;color:#94a3b8;margin-top:12px;line-height:1.6;">åå‰ãŒãªã„å ´åˆã¯<br>ã€Œè¨˜éŒ²å…¥åŠ› â†’ æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ• ï¼‹ç·¨é›†ã€ã§è¿½åŠ ã§ãã¾ã™</p>
    </div>

    <!-- STEP 2: PINå…¥åŠ› -->
    <div id="pin-step2" style="display:none;">
      <div id="pin-who" style="background:#eff6ff;border-radius:8px;padding:9px 14px;font-size:14px;font-weight:700;color:#1d4ed8;margin-bottom:14px;">ğŸ‘¤ â€”</div>
      <p class="sub" style="margin-bottom:6px;">PINã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      <div class="pin-hint-box">ğŸ”‘ ãƒ‡ãƒ¢ç”¨PINã‚³ãƒ¼ãƒ‰ï¼š<strong>1 2 3 4</strong></div>
      <div class="dots">
        <div class="dot" id="d0"></div>
        <div class="dot" id="d1"></div>
        <div class="dot" id="d2"></div>
        <div class="dot" id="d3"></div>
      </div>
      <div class="numpad">
        <button onclick="pi('1')">1</button>
        <button onclick="pi('2')">2</button>
        <button onclick="pi('3')">3</button>
        <button onclick="pi('4')">4</button>
        <button onclick="pi('5')">5</button>
        <button onclick="pi('6')">6</button>
        <button onclick="pi('7')">7</button>
        <button onclick="pi('8')">8</button>
        <button onclick="pi('9')">9</button>
        <button class="del" onclick="pd()">âŒ«</button>
        <button onclick="pi('0')">0</button>
        <button style="font-size:14px;background:#f0fdf4;border-color:#86efac;color:#15803d;" onclick="checkPin()">âœ“</button>
      </div>
      <button onclick="goBackToStep1()" style="margin-top:14px;font-size:12px;color:#94a3b8;background:none;border:none;cursor:pointer;text-decoration:underline;">â† æ‹…å½“è€…ã‚’é¸ã³ç›´ã™</button>
    </div>

    <div class="pin-err" id="perr"></div>
  </div>
</div>

<!-- ===== NAV ===== -->
<nav>
  <div class="nav-in">
    <div class="brand">
      <div>
        <h1>ä»‹è­·è¨˜éŒ² ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š<span id="login-name">â€”</span></p>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
      <div class="nav-btns">
        <button class="nav-btn on" onclick="sp('rec',this)">ğŸ“ è¨˜éŒ²å…¥åŠ›</button>
        <button class="nav-btn" onclick="sp('list',this)">ğŸ“‚ è¨˜éŒ²ä¸€è¦§</button>
        <button class="nav-btn" onclick="sp('dash',this)">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
        <button class="nav-btn" onclick="sp('setup',this)">âš™ï¸ å°å…¥ã‚¬ã‚¤ãƒ‰</button>
        <button class="nav-btn" id="nav-staff-btn" style="display:none;" onclick="sp('staff',this)">ğŸ‘¥ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</button>
        <button class="nav-btn" id="nav-settings-btn" style="display:none;" onclick="sp('settings',this)">ğŸ›  ç®¡ç†è¨­å®š</button>
      </div>
      <button class="lock-btn" onclick="openPinModal()" title="PINã‚³ãƒ¼ãƒ‰å¤‰æ›´">ğŸ”‘ PIN</button>
      <button class="lock-btn" onclick="lockScreen()" title="ç”»é¢ãƒ­ãƒƒã‚¯">ğŸ”’</button>
    </div>
  </div>
</nav>

<!-- ========== è¨˜éŒ²å…¥åŠ› ========== -->
<div class="page on" id="page-rec">
  <div class="g2">

    <!-- å·¦ï¼šãƒ•ã‚©ãƒ¼ãƒ  -->
    <div>
      <div class="card">
        <div class="card-title">ğŸ“‹ åŸºæœ¬æƒ…å ±</div>
        <div class="g2">
          <div class="fg"><label>ğŸ‘¤ åˆ©ç”¨è€…å *</label><input id="f-name" placeholder="ä¾‹ï¼šå±±ç”° èŠ±å­"></div>
          <div class="fg"><label>ğŸ“… è¨˜éŒ²æ—¥æ™‚</label><input id="f-dt" type="datetime-local"></div>
          <div class="fg">
            <label>ğŸ‘©â€âš•ï¸ æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ• *
              <button type="button" id="staff-edit-btn" onclick="openStaffMgr()" style="margin-left:8px;padding:2px 8px;font-size:10px;background:#fef3c7;border:1.5px solid #fde047;border-radius:6px;cursor:pointer;color:#b45309;font-weight:700;display:none;">ğŸ‘‘ ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†</button>
            </label>
            <select id="f-staff"><option value="">-- æ‹…å½“è€…ã‚’é¸æŠ --</option></select>
          </div>
          <div class="fg"><label>ğŸ·ï¸ ã‚µãƒ¼ãƒ“ã‚¹ç¨®åˆ¥</label>
            <select id="f-svc">
              <option>ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹</option><option>è¨ªå•ä»‹è­·</option>
              <option>æ–½è¨­å…¥å±…</option><option>ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ’‰ ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ <span style="font-size:11px;font-weight:400;color:#94a3b8;margin-left:4px;">å…¥åŠ›ã§è‡ªå‹•ãƒã‚§ãƒƒã‚¯</span></div>
        <div class="g2">
          <div class="fg"><label>ğŸŒ¡ï¸ ä½“æ¸©ï¼ˆâ„ƒï¼‰</label><input id="f-temp" type="number" step="0.1" placeholder="36.5" oninput="checkV()"></div>
          <div class="fg"><label>â¤ï¸ è¡€åœ§ï¼ˆmmHgï¼‰</label><input id="f-bp" placeholder="120/75" oninput="checkV()"></div>
          <div class="fg"><label>ğŸ’“ è„ˆæ‹ï¼ˆå›/åˆ†ï¼‰</label><input id="f-pulse" type="number" placeholder="72" oninput="checkV()"></div>
          <div class="fg"><label>ğŸ©¸ SpO2ï¼ˆ%ï¼‰</label><input id="f-spo2" type="number" placeholder="98" oninput="checkV()"></div>
        </div>
        <div id="v-alerts" style="margin-top:8px;"></div>
        <!-- æ­£å¸¸ç¯„å›²ç›®å®‰ -->
        <div style="margin-top:10px;background:#f8faff;border-radius:8px;padding:10px 12px;font-size:11px;color:#475569;line-height:1.9;">
          <strong style="color:var(--blue);">ğŸ“Š æ­£å¸¸ç¯„å›²ã®ç›®å®‰ï¼š</strong>
          ä½“æ¸© 36.0ã€œ37.0â„ƒã€€ï¼ã€€è¡€åœ§ 90ã€œ139/60ã€œ89mmHgã€€ï¼ã€€è„ˆæ‹ 60ã€œ100å›/åˆ†ã€€ï¼ã€€SpO2 95%ä»¥ä¸Š
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ› ã‚±ã‚¢è¨˜éŒ²</div>
        <div class="g2">
          <div class="fg"><label>ğŸ± é£Ÿäº‹é‡</label>
            <select id="f-meal"><option value="">é¸æŠ</option>
              <option>å…¨é‡æ‘‚å–</option><option>8å‰²ç¨‹åº¦æ‘‚å–</option>
              <option>åŠé‡æ‘‚å–</option><option>3å‰²ç¨‹åº¦æ‘‚å–</option><option>å°‘é‡æ‘‚å–</option><option>ã»ã¼æ‘‚å–ã§ããš</option>
            </select>
          </div>
          <div class="fg"><label>ğŸ’§ æ°´åˆ†æ‘‚å–</label>
            <select id="f-water"><option value="">é¸æŠ</option>
              <option>ååˆ†æ‘‚å–</option><option>å°‘é‡æ‘‚å–</option><option>æ‘‚å–æ‹’å¦ã‚ã‚Š</option>
            </select>
          </div>
          <div class="fg"><label>ğŸš¿ å…¥æµ´</label>
            <select id="f-bath"><option value="">é¸æŠ</option>
              <option>è‡ªç«‹å…¥æµ´ï¼ˆå•é¡Œãªã—ï¼‰</option><option>å…¥æµ´ä»‹åŠ©å®Ÿæ–½ï¼ˆå•é¡Œãªã—ï¼‰</option><option>ã‚·ãƒ£ãƒ¯ãƒ¼æµ´å®Ÿæ–½</option>
              <option>æ¸…æ‹­å®Ÿæ–½</option><option>æœ¬æ—¥ã¯å…¥æµ´ãªã—</option>
            </select>
          </div>
          <div class="fg"><label>ğŸš½ æ’æ³„</label>
            <select id="f-toilet"><option value="">é¸æŠ</option>
              <option>è‡ªç«‹æ’æ³„ï¼ˆå•é¡Œãªã—ï¼‰</option><option>ä¸€éƒ¨ä»‹åŠ©ã«ã¦æ’æ³„</option>
              <option>å…¨ä»‹åŠ©ã«ã¦æ’æ³„</option><option>ã‚ªãƒ ãƒ„äº¤æ›å®Ÿæ–½</option>
            </select>
          </div>
          <div class="fg"><label>ğŸš¶ ç§»å‹•</label>
            <select id="f-walk"><option value="">é¸æŠ</option>
              <option>è‡ªç«‹æ­©è¡Œï¼ˆå•é¡Œãªã—ï¼‰</option><option>æ­©è¡Œå™¨ä½¿ç”¨ã«ã¦ç§»å‹•</option>
              <option>è»Šæ¤…å­ã«ã¦ç§»å‹•</option><option>å…¨ä»‹åŠ©ã«ã¦ç§»å‹•</option>
            </select>
          </div>
          <div class="fg"><label>ğŸ˜Š æœ¬äººã®æ§˜å­</label>
            <select id="f-mood"><option value="">é¸æŠ</option>
              <option>ç¬‘é¡”ãŒã‚ã‚Šè‰¯å¥½</option><option>ç©ã‚„ã‹ãƒ»è½ã¡ç€ã„ã¦ã„ã‚‹</option>
              <option>ã‚„ã‚„å…ƒæ°—ãŒãªã„æ§˜å­</option><option>ä¸ç©ãƒ»èˆˆå¥®ãŒã¿ã‚‰ã‚ŒãŸ</option>
              <option>å‚¾çœ å‚¾å‘ã‚ã‚Š</option>
            </select>
          </div>
          <div class="fg full"><label>ğŸ“Œ ç‰¹è¨˜äº‹é …</label>
            <textarea id="f-note" placeholder="å¤‰åŒ–ãƒ»æ°—ã«ãªã‚‹ã“ã¨ãƒ»å®¶æ—ã¸ã®ç”³ã—é€ã‚Šãªã©"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- å³ï¼šAIç”Ÿæˆãƒ»å‡ºåŠ› -->
    <div>
      <div class="card">
        <div class="card-title">âœ¨ AIè¨˜éŒ²ç”Ÿæˆ</div>
        <div class="itabs">
          <div class="itab on" id="it-memo" onclick="sit('memo',this)">ğŸ¤ ãƒ¡ãƒ¢ãƒ»éŸ³å£°ã‹ã‚‰ç”Ÿæˆ</div>
          <div class="itab" id="it-form" onclick="sit('form',this)">ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç”Ÿæˆ</div>
        </div>

        <div class="ipane" id="ip-form">
          <div style="background:var(--bluebg);border-radius:8px;padding:12px;font-size:12px;color:#1d4ed8;">
            ğŸ’¡ å·¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€æ­£å¼ãªä»‹è­·è¨˜éŒ²æ–‡ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
          </div>
        </div>

        <div class="ipane on" id="ip-memo">
          <div class="voice-wrap">
            <p>ğŸ¤ éŸ³å£°ã§è©±ã™ or ãƒ¡ãƒ¢ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</p>
            <div style="background:#fffbeb;border-radius:6px;padding:8px 10px;font-size:11px;color:#92400e;margin-bottom:8px;line-height:1.7;">
              ğŸ’¬ <strong>èª­ã¿ä¸Šã’ä¾‹ï¼š</strong>ã€Œå±±ç”°ã•ã‚“ã€ä½“æ¸©36.5ã€è¡€åœ§120ã®75ã€è„ˆæ‹72ã€SpO2ã¯98ã€é£Ÿäº‹ã¯åŠåˆ†é£Ÿã¹ã¾ã—ãŸã€‚æ°´åˆ†ã¯ååˆ†ã¨ã‚Œã¦ã„ã¾ã™ã€‚å…¥æµ´ã¯è‡ªåˆ†ã§ã§ãã¾ã—ãŸã€‚æ’æ³„ã‚‚è‡ªç«‹ã€‚ç§»å‹•ã¯æ­©è¡Œå™¨ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚ç¬‘é¡”ã§è‰¯å¥½ã§ã™ã€‚ã€
              <div style="margin-top:4px;font-size:10.5px;color:#b45309;">ğŸ’¡ SpO2ã¯ã€Œãˆã™ã´ãƒ¼ãŠãƒ¼ã¤ãƒ¼98ã€ã¾ãŸã¯ã€Œ98ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã€ã®ã‚ˆã†ã«è©±ã™ã¨èªè­˜ã•ã‚Œã¾ã™ã€‚æ‹…å½“è€…ã¯é¸æŠæ¸ˆã¿ã®ãŸã‚å…¥åŠ›ä¸è¦ã§ã™ã€‚</div>
            </div>
            <textarea id="f-memo" style="width:100%;min-height:88px;"
              placeholder="ä¾‹ï¼šå±±ç”°ã•ã‚“ä½“æ¸©36.5è¡€åœ§120ã®75è„ˆæ‹72 SpO2ã¯98é£Ÿäº‹ã¯ã»ã¼å…¨é‡æ°´åˆ†ååˆ†å…¥æµ´è‡ªç«‹æ’æ³„è‡ªç«‹ç§»å‹•æ­©è¡Œå™¨ä½¿ç”¨ç¬‘é¡”ã§è‰¯å¥½ï¼ˆæ‹…å½“è€…ã¯è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ï¼‰"></textarea>
            <div style="display:flex;gap:8px;margin-top:10px;">
              <button class="btn bd" id="vbtn" onclick="toggleVoice()">ğŸ¤ éŸ³å£°å…¥åŠ› é–‹å§‹</button>
              <button class="btn bg" onclick="document.getElementById('f-memo').value=''">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
            </div>
            <div class="rec-ind" id="ri">
              <div class="rec-dot"></div><span>éŸ³å£°èªè­˜ä¸­... ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨åœæ­¢</span>
            </div>
          </div>
          <!-- è§£æãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
          <div id="memo-preview" style="display:none;">
            <div class="voice-check">
              <strong>âœ… è§£æãƒã‚§ãƒƒã‚¯ï¼ˆç”Ÿæˆå‰ã«ç¢ºèªã—ã¦ãã ã•ã„ï¼‰</strong>
              <div class="vc-items" id="vc-check-items"></div>
            </div>
          </div>
          <p style="font-size:11px;color:#94a3b8;margin-top:6px;">â€» éŸ³å£°å…¥åŠ›ã¯Chrome/Edgeã®ã¿å¯¾å¿œï¼ˆHTTPSç’°å¢ƒã§å‹•ä½œï¼‰</p>
        </div>

        <button class="btn bp" style="width:100%;justify-content:center;padding:13px;margin-top:14px;font-size:14px;" onclick="generate()">
          âœ¨ AIè¨˜éŒ²ã‚’ç”Ÿæˆã™ã‚‹
        </button>
        <div class="loading" id="gen-load"><div class="spin"></div>AIãŒè¨˜éŒ²ã‚’ç”Ÿæˆä¸­...</div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ“„ ç”Ÿæˆã•ã‚ŒãŸè¨˜éŒ²</div>
        <div class="out-box" id="out"></div>
        <div class="out-empty" id="out-empty">â† å…¥åŠ›ã—ã¦AIã§è¨˜éŒ²ã‚’ç”Ÿæˆã—ã¦ã¿ã¾ã—ã‚‡ã† ğŸ¤–</div>
        <div id="out-btns" style="display:none;">
          <div class="brow">
            <button class="btn bs" onclick="saveRec()">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
            <button class="btn bo" onclick="copyRec()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            <button class="btn bg" onclick="clearOut()">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ========== è¨˜éŒ²ä¸€è¦§ ========== -->
<div class="page" id="page-list">
  <div class="card">
    <div class="card-title">ğŸ“‚ ä»‹è­·è¨˜éŒ²ä¸€è¦§</div>
    <div class="frow">
      <input id="fs" placeholder="ğŸ” åˆ©ç”¨è€…åãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰" oninput="renderList()" style="flex:1;min-width:160px;">
      <select id="fst" onchange="renderList()"><option value="">å…¨ã‚¹ã‚¿ãƒƒãƒ•</option></select>
      <select id="fsvc" onchange="renderList()">
        <option value="">å…¨ã‚µãƒ¼ãƒ“ã‚¹</option>
        <option>ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹</option><option>è¨ªå•ä»‹è­·</option>
        <option>æ–½è¨­å…¥å±…</option><option>ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤</option>
      </select>
      <input id="fd1" type="date" onchange="renderList()">
      <span style="font-size:12px;color:#94a3b8;">ã€œ</span>
      <input id="fd2" type="date" onchange="renderList()">
      <button class="btn bg" onclick="clearF()">âœ• ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="btn bs" onclick="exportCSV()">ğŸ“¥ CSVå‡ºåŠ›</button>
    </div>
    <div class="twrap">
      <table>
        <thead><tr>
          <th>æ—¥æ™‚</th><th>åˆ©ç”¨è€…å</th><th>æ‹…å½“</th><th>ã‚µãƒ¼ãƒ“ã‚¹</th>
          <th>ãƒã‚¤ã‚¿ãƒ«</th><th>é£Ÿäº‹</th><th>æ§˜å­</th><th>æ“ä½œ</th>
        </tr></thead>
        <tbody id="list-body"></tbody>
      </table>
    </div>
    <div style="margin-top:8px;font-size:12px;color:#94a3b8;" id="list-cnt"></div>
  </div>
</div>

<!-- ========== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ========== -->
<div class="page" id="page-dash">
  <!-- æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="card" style="margin-bottom:16px;padding:16px 20px;">
    <div style="display:flex;align-items:center;flex-wrap:wrap;gap:10px;">
      <span style="font-size:13px;font-weight:700;color:var(--blue);">ğŸ“… è¡¨ç¤ºæœŸé–“ï¼š</span>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <button class="btn bg" id="dp-today" onclick="setDashPeriod('today',this)">ä»Šæ—¥</button>
        <button class="btn bg" id="dp-week"  onclick="setDashPeriod('week',this)">ä»Šé€±</button>
        <button class="btn bg" id="dp-month" onclick="setDashPeriod('month',this)" style="background:var(--blue);color:#fff;">ä»Šæœˆ</button>
        <button class="btn bg" id="dp-all"   onclick="setDashPeriod('all',this)">å…¨æœŸé–“</button>
        <button class="btn bg" id="dp-custom" onclick="setDashPeriod('custom',this)">ã‚«ã‚¹ã‚¿ãƒ </button>
      </div>
      <div id="dp-custom-range" style="display:none;align-items:center;gap:6px;">
        <input type="date" id="dp-from" onchange="updDash()" style="padding:7px 10px;font-size:13px;border:1.5px solid var(--border);border-radius:8px;font-family:inherit;">
        <span style="font-size:12px;color:#94a3b8;">ã€œ</span>
        <input type="date" id="dp-to" onchange="updDash()" style="padding:7px 10px;font-size:13px;border:1.5px solid var(--border);border-radius:8px;font-family:inherit;">
      </div>
      <span id="dp-label" style="font-size:12px;color:#94a3b8;"></span>
    </div>
  </div>

  <div class="stats">
    <div class="stat"><div class="n" id="st-total">0</div><div class="l">ğŸ“‹ æœŸé–“å†…è¨˜éŒ²æ•°</div><div class="s" id="st-period-label">ä»Šæœˆ</div></div>
    <div class="stat"><div class="n" id="st-today">0</div><div class="l">ğŸ“… æœ¬æ—¥ã®è¨˜éŒ²</div><div class="s" id="st-date">â€”</div></div>
    <div class="stat"><div class="n" id="st-users">0</div><div class="l">ğŸ‘¥ åˆ©ç”¨è€…æ•°</div><div class="s">æœŸé–“å†…</div></div>
    <div class="stat"><div class="n" id="st-alrt">0</div><div class="l">âš ï¸ è¦ç¢ºèª</div><div class="s">ãƒã‚¤ã‚¿ãƒ«ç•°å¸¸</div></div>
  </div>
  <div class="g2">
    <div class="card"><div class="card-title">ğŸ‘¥ åˆ©ç”¨è€…åˆ¥ è¨˜éŒ²ä»¶æ•°</div><div id="db-users"></div></div>
    <div class="card"><div class="card-title">ğŸ‘©â€âš•ï¸ æ‹…å½“è€…åˆ¥ è¨˜éŒ²ä»¶æ•°</div><div id="db-staff"></div></div>
    <div class="card"><div class="card-title">âš ï¸ ãƒã‚¤ã‚¿ãƒ«è¦ç¢ºèªãƒªã‚¹ãƒˆ</div><div id="db-alrt"></div></div>
    <div class="card"><div class="card-title">ğŸ± é£Ÿäº‹æ‘‚å–çŠ¶æ³ï¼ˆç›´è¿‘ï¼‰</div><div id="db-meal"></div></div>
    <div class="card"><div class="card-title">ğŸ˜Š åˆ©ç”¨è€…ã®æ§˜å­ï¼ˆç›´è¿‘ï¼‰</div><div id="db-mood"></div></div>
  </div>
</div>

<!-- è‡ªå‹•ãƒ­ãƒƒã‚¯è­¦å‘ŠãƒãƒŠãƒ¼ -->
<div id="auto-lock-warning">
  <span id="alw-text">â± æ“ä½œãŒãªã„ãŸã‚ã€é–“ã‚‚ãªãç”»é¢ãƒ­ãƒƒã‚¯ã—ã¾ã™</span>
  <span class="alw-close" onclick="dismissLockWarning()">&#10005;</span>
</div>

<!-- ========== å°å…¥ã‚¬ã‚¤ãƒ‰ ========== -->
<div class="page" id="page-setup">
  <div class="card">
    <div class="card-title">âš™ï¸ å®Ÿéš›ã®æ–½è¨­ã¸ã®å°å…¥æ–¹æ³•ï¼ˆå®Œå…¨ç„¡æ–™ï¼‰</div>
    <div style="background:var(--bluebg);border-radius:10px;padding:14px;margin-bottom:18px;font-size:13px;">
      <strong>ğŸ’¡ æ¨å¥¨æ§‹æˆï¼šã“ã®HTMLãƒ•ã‚¡ã‚¤ãƒ« ï¼‹ Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼ˆå®Œå…¨ç„¡æ–™ï¼‰</strong><br>
      <span style="color:#475569;">ã‚¹ã‚¿ãƒƒãƒ•ã¯URLã‚’é–‹ãã ã‘ã€‚ãƒ‡ãƒ¼ã‚¿ã¯Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è‡ªå‹•ä¿å­˜ã€‚è¤‡æ•°äººåŒæ™‚åˆ©ç”¨OKã€‚</span>
    </div>
    <div class="step"><div class="snum">1</div><div><h3>Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ</h3><p>Googleãƒ‰ãƒ©ã‚¤ãƒ–ã§æ–°è¦ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã€‚ã‚·ãƒ¼ãƒˆåã‚’ã€Œä»‹è­·è¨˜éŒ²ã€ã«å¤‰æ›´ã€‚</p></div></div>
    <div class="step"><div class="snum">2</div><div><h3>Apps Scriptï¼ˆGASï¼‰ã§APIã‚’ä½œæˆ</h3><p>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œæ‹¡å¼µæ©Ÿèƒ½ â†’ Apps Scriptã€ã‚’é–‹ãã€ä»¥ä¸‹ã‚’è²¼ã‚Šä»˜ã‘ãƒ»ä¿å­˜ã€‚</p>
      <div class="codebox">function doPost(e) {
  const s = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ä»‹è­·è¨˜éŒ²');
  const d = JSON.parse(e.postData.contents);
  s.appendRow([d.datetime,d.name,d.staff,d.service,d.temp,d.bp,d.pulse,d.spo2,d.meal,d.water,d.bath,d.toilet,d.walk,d.mood,d.note,d.alerts,d.record]);
  return ContentService.createTextOutput('{"status":"ok"}').setMimeType(ContentService.MimeType.JSON);
}</div></div></div>
    <div class="step"><div class="snum">3</div><div><h3>ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€ã—ã¦URLã‚’å–å¾—</h3><p>Apps Scriptã®ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ â†’ æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ â†’ ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã€ã‚’é¸æŠã€‚ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ã€Œå…¨å“¡ã€ã«è¨­å®šã—ã¦URLã‚’ã‚³ãƒ”ãƒ¼ã€‚</p></div></div>
    <div class="step"><div class="snum">4</div><div><h3>ã“ã®HTMLã®GAS_ENDPOINTã«è²¼ã‚Šä»˜ã‘</h3>
      <div class="codebox">const GAS_ENDPOINT = 'https://script.google.com/macros/s/ã‚ãªãŸã®ID/exec';</div></div></div>
    <div class="step"><div class="snum">5</div><div><h3>GitHub Pagesã§ç„¡æ–™å…¬é–‹ â†’ URLã‚’ã‚¹ã‚¿ãƒƒãƒ•ã«å…±æœ‰</h3><p>HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’GitHub Pagesã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆç„¡æ–™ãƒ»HTTPSå¯¾å¿œï¼‰ã€‚URLã‚’ã‚¹ã‚¿ãƒƒãƒ•ã«é€ã‚‹ã ã‘ã€‚éŸ³å£°å…¥åŠ›ã‚‚å‹•ä½œã—ã¾ã™ã€‚</p></div></div>
    <div style="background:var(--greenbg);border:1.5px solid #86efac;border-radius:10px;padding:14px;font-size:12.5px;line-height:2;">
      âœ… ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»PC ã©ã‚Œã§ã‚‚å¯¾å¿œ&nbsp;&nbsp;âœ… è¤‡æ•°ã‚¹ã‚¿ãƒƒãƒ•åŒæ™‚åˆ©ç”¨&nbsp;&nbsp;âœ… ã‚¯ãƒ©ã‚¦ãƒ‰è‡ªå‹•ä¿å­˜<br>
      âœ… åˆ©ç”¨è€…åˆ¥ãƒ»æ‹…å½“è€…åˆ¥ãƒ»æ—¥ä»˜åˆ¥ æ¤œç´¢ãƒ»çµã‚Šè¾¼ã¿&nbsp;&nbsp;âœ… CSV/Excelæ›¸ãå‡ºã—&nbsp;&nbsp;âœ… å®Œå…¨ç„¡æ–™
    </div>
  </div>
</div>

<!-- ========== ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰ ========== -->
<div class="page" id="page-staff">

  <!-- ç®¡ç†è€…ãƒãƒŠãƒ¼ -->
  <div style="background:var(--yellowbg);border:2px solid #fde047;border-radius:12px;padding:14px 20px;margin-bottom:18px;display:flex;align-items:center;gap:12px;">
    <span style="font-size:22px;">ğŸ‘¥</span>
    <div>
      <div style="font-size:13px;font-weight:800;color:#92400e;">ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰</div>
      <div style="font-size:11px;color:#b45309;" id="staff-page-admin-name">ç®¡ç†è€…ãŒãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿æ“ä½œã§ãã¾ã™</div>
    </div>
  </div>

  <!-- ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card" style="margin-bottom:18px;">
    <div class="card-title">â• ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;">
      <div style="flex:1;min-width:140px;">
        <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px;">ã‚¹ã‚¿ãƒƒãƒ•å</label>
        <input id="sp-new-name" placeholder="ä¾‹ï¼šå±±æœ¬ å¤ªéƒ" style="width:100%;padding:9px 11px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;">
      </div>
      <div>
        <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px;">å½¹å‰²</label>
        <select id="sp-new-role" style="padding:9px 11px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;background:#fff;">
          <option value="staff">ä¸€èˆ¬ã‚¹ã‚¿ãƒƒãƒ•</option>
          <option value="admin">ğŸ‘‘ ç®¡ç†è€…</option>
        </select>
      </div>
      <button class="btn bp" onclick="spAddStaff()" style="white-space:nowrap;">ï¼‹ è¿½åŠ </button>
    </div>
    <div style="margin-top:8px;font-size:11px;color:#94a3b8;">è¿½åŠ å¾Œã®åˆæœŸPINã¯ <strong>1234</strong> ã§ã™ã€‚æœ¬äººã«PINå¤‰æ›´ã‚’ä¿ƒã—ã¦ãã ã•ã„ã€‚<br>ğŸ‘‘ <strong>ç®¡ç†è€…</strong>: è¨­å®šå¤‰æ›´ãƒ»ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒ»å…¨PINå¤‰æ›´ãŒå¯èƒ½ãªç®¡ç†ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
  </div>

  <!-- ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
      <div class="card-title" style="margin:0;">ğŸ‘¤ ç™»éŒ²ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§</div>
      <span id="sp-staff-count" style="font-size:12px;color:var(--gray);background:var(--bluebg);padding:4px 10px;border-radius:20px;font-weight:600;"></span>
    </div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ã‚µãƒãƒª -->
    <div id="sp-login-summary" style="background:var(--graybg);border-radius:10px;padding:12px 14px;margin-bottom:14px;font-size:12px;color:var(--gray);"></div>

    <div id="sp-staff-list"></div>
  </div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ -->
  <div class="card" style="margin-top:18px;">
    <div class="card-title">ğŸ“‹ ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ï¼ˆç›´è¿‘10ä»¶ï¼‰</div>
    <div id="sp-login-log"></div>
  </div>

</div>

<!-- ========== ç®¡ç†è¨­å®šï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰ ========== -->
<div class="page" id="page-settings">

  <!-- èªè¨¼ãƒãƒŠãƒ¼ -->
  <div style="background:var(--yellowbg);border:2px solid #fde047;border-radius:12px;padding:14px 20px;margin-bottom:18px;display:flex;align-items:center;gap:12px;">
    <span style="font-size:22px;">ğŸ‘‘</span>
    <div>
      <div style="font-size:13px;font-weight:800;color:#92400e;">ç®¡ç†è€…å°‚ç”¨è¨­å®šãƒšãƒ¼ã‚¸</div>
      <div style="font-size:11px;color:#b45309;" id="settings-admin-name">ç®¡ç†è€…ãŒãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
  </div>

  <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š -->
  <div class="card settings-section">
    <div class="sec-title">ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</div>

    <div class="setting-row">
      <div>
        <div class="setting-label">è‡ªå‹•ç”»é¢ãƒ­ãƒƒã‚¯æ™‚é–“</div>
        <div class="setting-desc">æŒ‡å®šæ™‚é–“æ“ä½œãªã—ã®å ´åˆã€è‡ªå‹•ã§ãƒ­ãƒƒã‚¯ã—ã¾ã™ã€‚<br>
          <span style="color:#16a34a;font-weight:600;">â˜… ãŠã™ã™ã‚: 10åˆ†ï¼ˆå€‹äººæƒ…å ±ä¿è­·ã®ãƒãƒ©ãƒ³ã‚¹ï¼‰</span></div>
      </div>
      <div class="setting-control">
        <select id="set-autolock" onchange="saveSettings()">
          <option value="0">ç„¡åŠ¹ï¼ˆã™ã™ã‚ãªã„ï¼‰</option>
          <option value="5">5åˆ†</option>
          <option value="10" selected>10åˆ† â˜…ãŠã™ã™ã‚</option>
          <option value="15">15åˆ†</option>
          <option value="30">30åˆ†</option>
          <option value="60">1æ™‚é–“</option>
        </select>
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">ãƒ­ãƒƒã‚¯å‰è­¦å‘Šè¡¨ç¤º</div>
        <div class="setting-desc">ãƒ­ãƒƒã‚¯1åˆ†å‰ã«ç”»é¢ä¸Šéƒ¨ã«è­¦å‘Šã‚’è¡¨ç¤ºã—ã¾ã™ã€‚<br>
          <span style="color:#16a34a;font-weight:600;">â˜… ãŠã™ã™ã‚: ON</span></div>
      </div>
      <div class="setting-control">
        <label class="toggle"><input type="checkbox" id="set-lockwarn" checked onchange="saveSettings()"><span class="toggle-slider"></span></label>
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´è¨˜éŒ²</div>
        <div class="setting-desc">èª°ãŒã„ã¤ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã‹è¨˜éŒ²ã—ã¾ã™ã€‚<br>
          <span style="color:#16a34a;font-weight:600;">â˜… ãŠã™ã™ã‚: ON</span></div>
      </div>
      <div class="setting-control">
        <label class="toggle"><input type="checkbox" id="set-loginlog" checked onchange="saveSettings()"><span class="toggle-slider"></span></label>
      </div>
    </div>

  </div>

  <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: è¨˜éŒ²å…¥åŠ›è¨­å®š -->
  <div class="card settings-section">
    <div class="sec-title">ğŸ“ è¨˜éŒ²å…¥åŠ›è¨­å®š</div>

    <div class="setting-row">
      <div>
        <div class="setting-label">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ç¨®åˆ¥</div>
        <div class="setting-desc">è¨˜éŒ²å…¥åŠ›æ™‚ã®åˆæœŸé¸æŠå€¤ã€‚<br>
          <span style="color:#16a34a;font-weight:600;">â˜… ãŠã™ã™ã‚: ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹</span></div>
      </div>
      <div class="setting-control">
        <select id="set-defsvc" onchange="saveSettings()">
          <option value="">-- é¸æŠãªã— --</option>
          <option value="ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹" selected>ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ â˜…</option>
          <option value="è¨ªå•ä»‹è­·">è¨ªå•ä»‹è­·</option>
          <option value="æ–½è¨­å…¥å±…">æ–½è¨­å…¥å±…</option>
          <option value="ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤">ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤</option>
        </select>
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">ãƒã‚¤ã‚¿ãƒ«ç•°å¸¸æ™‚ã®è­¦å‘ŠéŸ³</div>
        <div class="setting-desc">å¼‚å¸¸å€¤æ¤œçŸ¥æ™‚ã«éŸ³ã§é€šçŸ¥ã—ã¾ã™ã€‚<br>
          <span style="color:#16a34a;font-weight:600;">â˜… ãŠã™ã™ã‚: ON</span></div>
      </div>
      <div class="setting-control">
        <label class="toggle"><input type="checkbox" id="set-alertsound" checked onchange="saveSettings()"><span class="toggle-slider"></span></label>
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">ä¿å­˜å¾Œè‡ªå‹•ã‚¯ãƒªã‚¢</div>
        <div class="setting-desc">è¨˜éŒ²ä¿å­˜å¾Œã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’è‡ªå‹•ã§ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚</div>
      </div>
      <div class="setting-control">
        <label class="toggle"><input type="checkbox" id="set-autoclear" onchange="saveSettings()"><span class="toggle-slider"></span></label>
      </div>
    </div>

  </div>

  <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: è¡¨ç¤ºè¨­å®š -->
  <div class="card settings-section">
    <div class="sec-title">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¨­å®š</div>

    <div class="setting-row">
      <div>
        <div class="setting-label">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºæœŸé–“</div>
        <div class="setting-desc">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ã„ãŸæ™‚ã®åˆæœŸè¡¨ç¤ºæœŸé–“ã€‚<br>
          <span style="color:#16a34a;font-weight:600;">â˜… ãŠã™ã™ã‚: ä»Šæœˆ</span></div>
      </div>
      <div class="setting-control">
        <select id="set-dashperiod" onchange="saveSettings()">
          <option value="today">ä»Šæ—¥</option>
          <option value="week">ä»Šé€±</option>
          <option value="month" selected>ä»Šæœˆ â˜…</option>
          <option value="all">å…¨æœŸé–“</option>
        </select>
      </div>
    </div>

  </div>

  <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: ã‚·ã‚¹ãƒ†ãƒ è¨­å®š -->
  <div class="card settings-section">
    <div class="sec-title">ğŸ¥ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</div>

    <div class="setting-row">
      <div>
        <div class="setting-label">ã‚·ã‚¹ãƒ†ãƒ å</div>
        <div class="setting-desc">ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚·ã‚¹ãƒ†ãƒ åã€‚</div>
      </div>
      <div class="setting-control">
        <input type="text" id="set-sysname" value="ä»‹è­·è¨˜éŒ² ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ " oninput="saveSettings()">
      </div>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">GASã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆGoogleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºï¼‰</div>
        <div class="setting-desc">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è‡ªå‹•ä¿å­˜ã™ã‚‹å ´åˆã«GAS URLã‚’è¨­å®šã€‚</div>
      </div>
      <div class="setting-control">
        <input type="text" id="set-gas" placeholder="https://script.google.com/..." style="width:220px;" oninput="saveSettings()">
      </div>
    </div>

  </div>

  <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³5: ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
  <div class="card settings-section">
    <div class="sec-title">ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
    <div style="background:var(--redbg);border:1.5px solid #fca5a5;border-radius:10px;padding:14px;margin-bottom:14px;font-size:12.5px;color:#7f1d1d;">
      âš ï¸ ä¸‹è¨˜ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆCSVå‡ºåŠ›ï¼‰ã‚’è¡Œã£ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
    </div>
    <div class="brow">
      <button class="btn bo" onclick="exportCSV()">ğŸ“¥ å…¨è¨˜éŒ²CSVoutï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰</button>
      <button class="btn" style="background:var(--redbg);color:var(--red);" onclick="clearAllData()">ğŸ—‘ å…¨è¨˜éŒ²ã‚’å‰Šé™¤</button>
    </div>
    <div style="margin-top:14px;">
      <div class="setting-label" style="font-size:12px;">ğŸ”‘ ã‚¹ã‚¿ãƒƒãƒ•è¨­å®šãƒªã‚»ãƒƒãƒˆ</div>
      <div style="font-size:11px;color:#94a3b8;margin-bottom:8px;">å…¨ã‚¹ã‚¿ãƒƒãƒ•ã®PINã‚’åˆæœŸå€¤ï¼ˆ1234ï¼‰ã«æˆ»ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ãƒƒãƒ•æ§‹æˆã«æ‰‹å‹•ã§ãƒªã‚»ãƒƒãƒˆã€‚</div>
      <button class="btn bg" onclick="resetStaffPins()">ğŸ”„ å…¨PINã‚’åˆæœŸåŒ–ï¼ˆ1234ï¼‰</button>
    </div>
  </div>

  <!-- ãŠã™ã™ã‚è¨­å®šã‚µãƒãƒª -->
  <div class="card" style="background:var(--greenbg);border:1.5px solid #86efac;">
    <div class="card-title" style="color:var(--green);">&#10003; ãŠã™ã™ã‚è¨­å®šæ§‹æˆï¼ˆç«‹ã¡ä¸Šã’æ™‚ï¼‰</div>
    <div style="font-size:12.5px;line-height:2;color:#166534;">
      ğŸ”’ <strong>è‡ªå‹•ãƒ­ãƒƒã‚¯</strong>: 10åˆ†ï¼ˆå€‹äººæƒ…å ±ä¿è­·ã¨æ¥­å‹™åŠ¹ç‡ã®ãƒãƒ©ãƒ³ã‚¹ï¼‰<br>
      ğŸ”” <strong>ãƒ­ãƒƒã‚¯å‰è­¦å‘Š</strong>: ONï¼ˆæŠ•ä¸ä¸­ã®è¨˜éŒ²ãŒæ¶ˆãˆã‚‹ã®ã‚’é˜²ãï¼‰<br>
      ğŸ± <strong>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹</strong>: ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆæœ€å¤šåˆ©ç”¨ã®æ–½è¨­ã«åˆã‚ã›ã¦å¤‰æ›´ï¼‰<br>
      ğŸ“ˆ <strong>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</strong>: ä»Šæœˆï¼ˆå½“æœˆã®çŠ¶æ³ã‚’ã™ãç¢ºèªï¼‰<br>
      ğŸ”” <strong>ãƒã‚¤ã‚¿ãƒ«è­¦å‘ŠéŸ³</strong>: ONï¼ˆç•°å¸¸å€¤ã‚’éŸ³ã§é€šçŸ¥ï¼‰<br>
      ğŸ‘‘ <strong>å„å¸«å€‹åˆ¥PIN</strong>: è‡ªåˆ†ã®IDç•ªå·è¡Œ4æ¡ç­‰ã‚’æ¨å¥¨ï¼ˆæœ€åˆã¯1234ï¼‰
    </div>
    <button class="btn bp" style="margin-top:14px;" onclick="applyRecommendedSettings()">â­ ãŠã™ã™ã‚è¨­å®šã‚’é©ç”¨</button>
  </div>

</div>

<!-- ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="staff-modal" onclick="closeStaffModal(event)">
  <div class="modal" style="max-width:460px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid var(--bluebg);">
      <h3 style="margin:0;padding:0;border:none;">ğŸ‘©â€âš•ï¸ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</h3>
      <span style="cursor:pointer;font-size:20px;color:var(--gray);" onclick="document.getElementById('staff-modal').classList.remove('on')">âœ•</span>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
      <input id="new-staff-input" placeholder="ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›" style="flex:1;min-width:120px;padding:9px 11px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;">
      <select id="new-staff-role" style="padding:9px 11px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;background:#fff;">
        <option value="staff">ä¸€èˆ¬ã‚¹ã‚¿ãƒƒãƒ•</option>
        <option value="admin">ğŸ‘‘ ç®¡ç†è€…</option>
      </select>
      <button class="btn bp" onclick="addStaff()">ï¼‹ è¿½åŠ </button>
    </div>
    <div style="margin-bottom:12px;font-size:11px;color:#94a3b8;">åˆæœŸPINã¯ <strong>1234</strong>ã€‚ç®¡ç†è€…ã¯å…¨å“¡ã®PINã‚’å¤‰æ›´ã§ãã¾ã™ã€‚</div>
    <div id="staff-list-box" style="max-height:320px;overflow-y:auto;"></div>
    <div style="margin-top:14px;font-size:11px;color:#94a3b8;">â€» ç™»éŒ²ã—ãŸã‚¹ã‚¿ãƒƒãƒ•ã¯æ‹…å½“è€…ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã¨ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«åæ˜ ã•ã‚Œã¾ã™</div>
  </div>
</div>

<!-- PINå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="pin-modal" onclick="closePinModal(event)">
  <div class="modal" style="max-width:360px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid var(--bluebg);">
      <h3 style="margin:0;padding:0;border:none;">ğŸ”‘ PINã‚³ãƒ¼ãƒ‰å¤‰æ›´</h3>
      <span style="cursor:pointer;font-size:20px;color:var(--gray);" onclick="document.getElementById('pin-modal').classList.remove('on')">âœ•</span>
    </div>
    <p id="pin-modal-who" style="font-size:13px;font-weight:600;margin-bottom:12px;color:var(--blue);"></p>
    <div class="fg" style="margin-bottom:10px;">
      <label>ç¾åœ¨ã®PINï¼ˆ4æ¡ï¼‰</label>
      <input id="pm-current" type="password" maxlength="4" inputmode="numeric" placeholder="ç¾åœ¨ã®PINã‚’å…¥åŠ›" style="width:100%;padding:9px 11px;border:1.5px solid var(--border);border-radius:8px;font-size:15px;font-family:inherit;letter-spacing:6px;">
    </div>
    <div class="fg" style="margin-bottom:10px;">
      <label>æ–°ã—ã„PINï¼ˆ4æ¡ã®æ•°å­—ï¼‰</label>
      <input id="pm-new" type="password" maxlength="4" inputmode="numeric" placeholder="æ–°ã—ã„PINã‚’å…¥åŠ›" style="width:100%;padding:9px 11px;border:1.5px solid var(--border);border-radius:8px;font-size:15px;font-family:inherit;letter-spacing:6px;">
    </div>
    <div class="fg" style="margin-bottom:16px;">
      <label>æ–°ã—ã„PINï¼ˆç¢ºèªï¼‰</label>
      <input id="pm-confirm" type="password" maxlength="4" inputmode="numeric" placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›" style="width:100%;padding:9px 11px;border:1.5px solid var(--border);border-radius:8px;font-size:15px;font-family:inherit;letter-spacing:6px;">
    </div>
    <p id="pm-err" style="color:var(--red);font-size:12px;min-height:18px;margin-bottom:10px;"></p>
    <div class="brow">
      <button class="btn bp" onclick="savePinChange()">ğŸ’¾ å¤‰æ›´ã™ã‚‹</button>
      <button class="btn bg" onclick="document.getElementById('pin-modal').classList.remove('on')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="modal" onclick="closeModal(event)">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid var(--bluebg);">
      <h3 style="margin:0;padding:0;border:none;" id="m-title">è¨˜éŒ²è©³ç´°</h3>
      <span style="cursor:pointer;font-size:20px;color:var(--gray);" onclick="document.getElementById('modal').classList.remove('on')">âœ•</span>
    </div>
    <pre id="m-body"></pre>
    <div class="brow" style="margin-top:14px;">
      <button class="btn bo" onclick="copyModal()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      <button class="btn bg" onclick="document.getElementById('modal').classList.remove('on')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
<div class="toast" id="toast"></div>

<script>
// ===== è¨­å®š =====
const GAS_ENDPOINT = ''; // æœ¬ç•ªå°å…¥æ™‚ã«GASã®URLã‚’å…¥ã‚Œã¦ãã ã•ã„

// ===== APPè¨­å®šï¼ˆç®¡ç†è€…ãŒå¤‰æ›´å¯èƒ½ï¼‰ =====
var DEFAULT_SETTINGS = {
  autoLockMinutes : 10,
  lockWarning     : true,
  loginLog        : true,
  defaultService  : 'ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹',
  alertSound      : true,
  autoClear       : false,
  dashPeriodDef   : 'month',
  systemName      : 'ä»‹è­·è¨˜éŒ² ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ',
  gasEndpoint     : ''
};
var APP_SETTINGS = (function(){
  try{ return Object.assign({}, DEFAULT_SETTINGS, JSON.parse(localStorage.getItem('careSettings')||'{}')); } catch(e){ return Object.assign({}, DEFAULT_SETTINGS); }
})();

function saveSettings(){
  APP_SETTINGS.autoLockMinutes = parseInt(document.getElementById('set-autolock').value)||0;
  APP_SETTINGS.lockWarning     = document.getElementById('set-lockwarn').checked;
  APP_SETTINGS.loginLog        = document.getElementById('set-loginlog').checked;
  APP_SETTINGS.defaultService  = document.getElementById('set-defsvc').value;
  APP_SETTINGS.alertSound      = document.getElementById('set-alertsound').checked;
  APP_SETTINGS.autoClear       = document.getElementById('set-autoclear').checked;
  APP_SETTINGS.dashPeriodDef   = document.getElementById('set-dashperiod').value;
  APP_SETTINGS.systemName      = document.getElementById('set-sysname').value.trim() || 'ä»‹è­·è¨˜éŒ² ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ';
  APP_SETTINGS.gasEndpoint     = document.getElementById('set-gas').value.trim();
  localStorage.setItem('careSettings', JSON.stringify(APP_SETTINGS));
  applySettings();
  resetAutoLockTimer();
  toast('âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

function loadSettingsUI(){
  document.getElementById('set-autolock').value     = APP_SETTINGS.autoLockMinutes;
  document.getElementById('set-lockwarn').checked   = APP_SETTINGS.lockWarning;
  document.getElementById('set-loginlog').checked   = APP_SETTINGS.loginLog;
  document.getElementById('set-defsvc').value       = APP_SETTINGS.defaultService;
  document.getElementById('set-alertsound').checked = APP_SETTINGS.alertSound;
  document.getElementById('set-autoclear').checked  = APP_SETTINGS.autoClear;
  document.getElementById('set-dashperiod').value   = APP_SETTINGS.dashPeriodDef;
  document.getElementById('set-sysname').value      = APP_SETTINGS.systemName;
  document.getElementById('set-gas').value          = APP_SETTINGS.gasEndpoint || '';
}

function applySettings(){
  // ã‚·ã‚¹ãƒ†ãƒ åå¤‰æ›´
  var sn = APP_SETTINGS.systemName;
  document.querySelectorAll('.brand h1, #pin-screen h2').forEach(function(el){ el.textContent = sn; });
  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æœŸé–“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  dashPeriod = APP_SETTINGS.dashPeriodDef;
}

function applyRecommendedSettings(){
  if(!confirm('ãŠã™ã™ã‚è¨­å®šã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿï¼ˆè‡ªå‹•ãƒ­ãƒƒã‚¯10åˆ†ã€è­¦å‘ŠONã€ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€ãƒã‚¤ã‚¿ãƒ«è­¦å‘ŠéŸ³ONï¼‰')) return;
  APP_SETTINGS.autoLockMinutes = 10;
  APP_SETTINGS.lockWarning     = true;
  APP_SETTINGS.loginLog        = true;
  APP_SETTINGS.defaultService  = 'ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹';
  APP_SETTINGS.alertSound      = true;
  APP_SETTINGS.autoClear       = false;
  APP_SETTINGS.dashPeriodDef   = 'month';
  localStorage.setItem('careSettings', JSON.stringify(APP_SETTINGS));
  loadSettingsUI();
  applySettings();
  resetAutoLockTimer();
  toast('â˜… ãŠã™ã™ã‚è¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸï¼');
}

function clearAllData(){
  if(!confirm('å…¨ã¦ã®ä»‹è­·è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;
  if(!confirm('æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿäº‹å‰ã«CSVå‡ºåŠ›ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚')) return;
  DB = [];
  localStorage.setItem('careDB', JSON.stringify(DB));
  renderList(); updDash();
  toast('ğŸ—‘ å…¨è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

function resetStaffPins(){
  if(!confirm('å…¨ã‚¹ã‚¿ãƒƒãƒ•ã®PINã‚’1234ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  STAFF_DATA.forEach(function(s){ s.pin = '1234'; });
  saveStaffs();
  toast('ğŸ”„ å…¨PINã‚’åˆæœŸåŒ–ï¼ˆ1234ï¼‰ã—ã¾ã—ãŸ');
}

// ===== è‡ªå‹•ãƒ­ãƒƒã‚¯ =====
var _lockTimer = null;
var _lockWarnTimer = null;
var _lastActivity = Date.now();
var _lockWarningShown = false;

function resetAutoLockTimer(){
  clearTimeout(_lockTimer);
  clearTimeout(_lockWarnTimer);
  dismissLockWarning();
  _lockWarningShown = false;
  _lastActivity = Date.now();
  var mins = parseInt(APP_SETTINGS.autoLockMinutes) || 0;
  if(mins <= 0) return;
  var lockMs = mins * 60 * 1000;
  var warnMs = lockMs - 60000; // 1åˆ†å‰è­¦å‘Š
  if(warnMs > 0 && APP_SETTINGS.lockWarning){
    _lockWarnTimer = setTimeout(function(){
      // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿è­¦å‘Š
      if(document.getElementById('pin-screen').style.display==='none' || document.getElementById('pin-screen').style.display===''){
        if(document.getElementById('pin-screen').style.display !== 'flex'){
          showLockWarning(1);
        }
      }
    }, warnMs);
  }
  _lockTimer = setTimeout(function(){
    // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã¿è‡ªå‹•ãƒ­ãƒƒã‚¯
    var ps = document.getElementById('pin-screen');
    if(ps && ps.style.display !== 'flex'){
      dismissLockWarning();
      lockScreen();
      toast('â± æ“ä½œãªã—ã®ãŸã‚ç”»é¢ã‚’ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ');
    }
  }, lockMs);
}

function showLockWarning(remainMin){
  var el = document.getElementById('auto-lock-warning');
  if(!el) return;
  document.getElementById('alw-text').textContent = 'â± æ“ä½œãŒãªã„ãŸã‚ã€ç´„'+remainMin+'åˆ†å¾Œã«è‡ªå‹•ãƒ­ãƒƒã‚¯ã—ã¾ã™';
  el.style.display = 'flex';
  _lockWarningShown = true;
}
function dismissLockWarning(){
  var el = document.getElementById('auto-lock-warning');
  if(el) el.style.display = 'none';
  _lockWarningShown = false;
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ¤œçŸ¥â†’ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
function _onUserActivity(){
  var ps = document.getElementById('pin-screen');
  if(ps && ps.style.display === 'flex') return; // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãªã‚‰ãƒªã‚»ãƒƒãƒˆã—ãªã„
  _lastActivity = Date.now();
  if(parseInt(APP_SETTINGS.autoLockMinutes) > 0){
    if(_lockWarningShown){ dismissLockWarning(); }
    resetAutoLockTimer();
  }
}
['click','keydown','touchstart','mousemove'].forEach(function(ev){
  document.addEventListener(ev, _onUserActivity, {passive:true});
});

// ===== ãƒ­ã‚°ã‚¤ãƒ³ä¸­æ‹…å½“è€… =====
var currentLoginStaff = sessionStorage.getItem('careLoginStaff') || '';

// ===== ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ï¼ˆname/pin/roleï¼‰ =====
var DEFAULT_STAFF_DATA = [
  {name:'éˆ´æœ¨ æµ',  pin:'1234', role:'admin'},
  {name:'ç”°ä¸­ ç¾å’²', pin:'1234', role:'staff'},
  {name:'ä½è—¤ å¥',  pin:'1234', role:'staff'}
];

function initStaffData(){
  // æ–°å½¢å¼ï¼ˆcareStaffDataï¼‰ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
  var saved = localStorage.getItem('careStaffData');
  if(saved){
    try{ return JSON.parse(saved); } catch(e){}
  }
  // æ—§å½¢å¼ï¼ˆcareStaffsï¼šæ–‡å­—åˆ—é…åˆ—ï¼‰ã‹ã‚‰ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  var old = localStorage.getItem('careStaffs');
  if(old){
    try{
      var arr = JSON.parse(old);
      if(Array.isArray(arr) && typeof arr[0]==='string'){
        var migrated = arr.map(function(n,i){ return {name:n, pin:'1234', role: i===0?'admin':'staff'}; });
        localStorage.setItem('careStaffData', JSON.stringify(migrated));
        return migrated;
      }
    } catch(e){}
  }
  return DEFAULT_STAFF_DATA;
}

var STAFF_DATA = initStaffData();

// å¾Œæ–¹äº’æ›ç”¨ï¼ˆåå‰é…åˆ—ï¼‰
function getStaffNames(){ return STAFF_DATA.map(function(s){ return s.name; }); }

function saveStaffs(){
  localStorage.setItem('careStaffData', JSON.stringify(STAFF_DATA));
  // æ—§keyã‚‚æ›´æ–°ã—ã¦äº’æ›æ€§ç¶­æŒ
  localStorage.setItem('careStaffs', JSON.stringify(getStaffNames()));
}

function isAdmin(name){
  var s = STAFF_DATA.find(function(x){ return x.name === name; });
  return s && s.role === 'admin';
}

// ===== ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ =====
function renderLoginStaffList(){
  var box = document.getElementById('pin-staff-list');
  if(!box) return;
  if(!STAFF_DATA.length){
    box.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;font-size:13px;">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
    return;
  }
  box.innerHTML = STAFF_DATA.map(function(s){
    var badge = s.role==='admin' ? '<span style="font-size:10px;background:#fef3c7;color:#b45309;padding:2px 6px;border-radius:10px;margin-left:6px;">ğŸ‘‘ ç®¡ç†è€…</span>' : '';
    var esc = s.name.replace(/'/g,"\\'");
    return '<button onclick="selectLoginStaff(\''+esc+'\')" style="width:100%;padding:11px 14px;margin-bottom:8px;border:1.5px solid var(--border);border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;background:#fafafa;text-align:left;display:flex;align-items:center;gap:8px;">'
      +'<span style="font-size:18px;">ğŸ‘¤</span><span>'+s.name+'</span>'+badge
      +'<span style="margin-left:auto;font-size:12px;color:#94a3b8;">â–¶</span></button>';
  }).join('');
}

function selectLoginStaff(name){
  currentLoginStaff = name;
  document.getElementById('pin-step1').style.display = 'none';
  document.getElementById('pin-step2').style.display = 'block';
  document.getElementById('pin-who').textContent = 'ğŸ‘¤ '+name;
  pinBuf = '';
  updDots();
  document.getElementById('perr').textContent = '';
}

function goBackToStep1(){
  document.getElementById('pin-step1').style.display = 'block';
  document.getElementById('pin-step2').style.display = 'none';
  pinBuf = '';
  updDots();
  document.getElementById('perr').textContent = '';
  currentLoginStaff = '';
}

function refreshStaffSelect(){
  var sel = document.getElementById('f-staff');
  var cur = sel.value;
  sel.innerHTML = '<option value="">-- æ‹…å½“è€…ã‚’é¸æŠ --</option>' +
    STAFF_DATA.map(function(s){ return '<option value="'+s.name+'"'+(s.name===cur?' selected':'')+'>'+s.name+(s.role==='admin'?' ğŸ‘‘':'')+'</option>'; }).join('');
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã‚»ãƒ¬ã‚¯ãƒˆã‚‚æ›´æ–°
  var fst = document.getElementById('fst');
  if(fst){
    var fv = fst.value;
    fst.innerHTML = '<option value="">å…¨ã‚¹ã‚¿ãƒƒãƒ•</option>' +
      STAFF_DATA.map(function(s){ return '<option value="'+s.name+'"'+(s.name===fv?' selected':'')+'>'+s.name+(s.role==='admin'?' ğŸ‘‘':'')+'</option>'; }).join('');
  }
}

function openStaffMgr(){
  if(!isAdmin(currentLoginStaff)){
    toast('âš ï¸ ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†ã¯ç®¡ç†è€…ã®ã¿æ“ä½œã§ãã¾ã™');
    return;
  }
  renderStaffList();
  document.getElementById('staff-modal').classList.add('on');
}

function closeStaffModal(e){
  if(e.target === document.getElementById('staff-modal'))
    document.getElementById('staff-modal').classList.remove('on');
}

function renderStaffList(){
  var box = document.getElementById('staff-list-box');
  if(!STAFF_DATA.length){
    box.innerHTML = '<div style="text-align:center;padding:16px;color:#94a3b8;font-size:13px;">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
    return;
  }
  var viewerIsAdmin = isAdmin(currentLoginStaff);
  box.innerHTML = STAFF_DATA.map(function(s,i){
    var badge = s.role==='admin'
      ? '<span style="font-size:10px;background:#fef3c7;color:#b45309;padding:2px 7px;border-radius:10px;margin-left:6px;">ğŸ‘‘ ç®¡ç†è€…</span>'
      : '<span style="font-size:10px;background:#f1f5f9;color:#64748b;padding:2px 7px;border-radius:10px;margin-left:6px;">ä¸€èˆ¬</span>';
    var pinBtn = (viewerIsAdmin || s.name === currentLoginStaff)
      ? '<button class="btn" style="padding:4px 10px;font-size:11px;background:#eff6ff;color:#2563eb;border-color:#bfdbfe;" onclick="changeStaffPin('+i+')">ğŸ”‘ PINå¤‰æ›´</button>'
      : '';
    var roleBtn = viewerIsAdmin
      ? '<button class="btn" style="padding:4px 10px;font-size:11px;background:#f0fdf4;color:#15803d;border-color:#86efac;" onclick="toggleStaffRole('+i+')">'+( s.role==='admin' ? 'â¬‡ ä¸€èˆ¬ã«' : 'â¬† ç®¡ç†è€…ã«' )+'</button>'
      : '';
    var delBtn = viewerIsAdmin
      ? '<button class="btn" style="padding:4px 10px;font-size:11px;background:var(--redbg);color:var(--red);" onclick="deleteStaff('+i+')">ğŸ—‘</button>'
      : '';
    return '<div style="padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;margin-bottom:8px;background:#fafafa;">'
      +'<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">'
      +'<span style="font-size:13px;font-weight:600;">ğŸ‘¤ '+s.name+badge+'</span>'
      +'</div>'
      +'<div style="display:flex;gap:5px;flex-wrap:wrap;">'
      +'<button class="btn bg" style="padding:4px 10px;font-size:11px;" onclick="editStaff('+i+')">âœï¸ åå‰å¤‰æ›´</button>'
      +pinBtn+roleBtn+delBtn
      +'</div></div>';
  }).join('');
}

function addStaff(){
  var inp  = document.getElementById('new-staff-input');
  var roleSel = document.getElementById('new-staff-role');
  var name = inp.value.trim();
  var role = roleSel ? roleSel.value : 'staff';
  if(!name){ toast('âš ï¸ ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if(STAFF_DATA.find(function(s){ return s.name===name; })){ toast('âš ï¸ ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™'); return; }
  STAFF_DATA.push({name:name, pin:'1234', role:role});
  saveStaffs();
  refreshStaffSelect();
  renderStaffList();
  renderLoginStaffList();
  inp.value = '';
  toast('âœ… '+name+' ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆåˆæœŸPIN: 1234ï¼‰');
}

function editStaff(idx){
  var s = STAFF_DATA[idx];
  var newName = prompt('æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', s.name);
  if(!newName || !newName.trim()) return;
  var old = s.name;
  STAFF_DATA[idx].name = newName.trim();
  if(currentLoginStaff === old) currentLoginStaff = newName.trim();
  saveStaffs();
  refreshStaffSelect();
  renderStaffList();
  renderLoginStaffList();
  toast('âœ… æ›´æ–°ã—ã¾ã—ãŸ');
}

function deleteStaff(idx){
  var s = STAFF_DATA[idx];
  if(!confirm('ã€Œ'+s.name+'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  STAFF_DATA.splice(idx,1);
  saveStaffs();
  refreshStaffSelect();
  renderStaffList();
  renderLoginStaffList();
  toast('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ');
}

function toggleStaffRole(idx){
  if(!isAdmin(currentLoginStaff)){ toast('âš ï¸ ç®¡ç†è€…ã®ã¿å¤‰æ›´ã§ãã¾ã™'); return; }
  STAFF_DATA[idx].role = (STAFF_DATA[idx].role === 'admin') ? 'staff' : 'admin';
  saveStaffs();
  renderStaffList();
  renderLoginStaffList();
  toast('âœ… ãƒ­ãƒ¼ãƒ«ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
}

function changeStaffPin(idx){
  var target = STAFF_DATA[idx];
  var viewerIsAdmin = isAdmin(currentLoginStaff);
  var isSelf = target.name === currentLoginStaff;
  if(!viewerIsAdmin && !isSelf){ toast('âš ï¸ è‡ªåˆ†ã®PINã®ã¿å¤‰æ›´ã§ãã¾ã™'); return; }
  // PINãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆå¯¾è±¡ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¿æŒï¼‰
  document.getElementById('pin-modal').dataset.targetIdx = idx;
  document.getElementById('pin-modal-who').textContent = 'ğŸ”‘ ã€Œ'+target.name+'ã€ã®PINã‚’å¤‰æ›´';
  document.getElementById('pm-current').value = '';
  document.getElementById('pm-new').value = '';
  document.getElementById('pm-confirm').value = '';
  document.getElementById('pm-err').textContent = '';
  document.getElementById('pin-modal').classList.add('on');
}

// ===== çŠ¶æ…‹ =====
var DB    = JSON.parse(localStorage.getItem('careDB') || '[]');
var recog = null;
var recOn = false;
var pinBuf = '';

// ===== PIN =====
function pi(n){
  if(pinBuf.length >= 4) return;
  pinBuf += n;
  updDots();
  if(pinBuf.length === 4) setTimeout(checkPin, 180);
}
function pd(){
  pinBuf = pinBuf.slice(0,-1);
  updDots();
  document.getElementById('perr').textContent = '';
}
function updDots(){
  for(var i=0;i<4;i++){
    document.getElementById('d'+i).className = 'dot' + (i < pinBuf.length ? ' on' : '');
  }
}
function checkPin(){
  var staff = STAFF_DATA.find(function(s){ return s.name === currentLoginStaff; });
  var correctPin = staff ? staff.pin : '1234';
  if(pinBuf === correctPin){
    document.getElementById('pin-screen').style.display = 'none';
    var dispName = currentLoginStaff || 'â€”';
    document.getElementById('login-name').textContent = dispName;
    // ãƒ•ã‚©ãƒ¼ãƒ ã®æ‹…å½“è€…ã‚’è‡ªå‹•ã‚»ãƒƒãƒˆ
    if(currentLoginStaff){
      var staffSel = document.getElementById('f-staff');
      for(var i=0;i<staffSel.options.length;i++){
        if(staffSel.options[i].value === currentLoginStaff){ staffSel.value = currentLoginStaff; break; }
      }
    }
    sessionStorage.setItem('careLoginStaff', currentLoginStaff);
    // ç®¡ç†è€…ãªã‚‰è¨­å®šãƒ»ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒœã‚¿ãƒ³ï¼‹ç·¨é›†ãƒœã‚¿ãƒ³è¡¨ç¤º
    var isAdminUser = isAdmin(currentLoginStaff);
    var settingsBtn = document.getElementById('nav-settings-btn');
    var staffNavBtn = document.getElementById('nav-staff-btn');
    var staffEditBtn = document.getElementById('staff-edit-btn');
    if(settingsBtn)  settingsBtn.style.display  = isAdminUser ? '' : 'none';
    if(staffNavBtn)  staffNavBtn.style.display  = isAdminUser ? '' : 'none';
    if(staffEditBtn) staffEditBtn.style.display = isAdminUser ? '' : 'none';
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ï¼ˆå¸¸ã«ä¸Šæ›¸ãï¼‰
    if(APP_SETTINGS.defaultService){
      var svcSel = document.getElementById('f-svc');
      if(svcSel) svcSel.value = APP_SETTINGS.defaultService;
    }
    // ãƒ­ã‚°è¨˜éŒ²
    if(APP_SETTINGS.loginLog){
      var logs = JSON.parse(localStorage.getItem('careLoginLogs')||'[]');
      logs.unshift({name:currentLoginStaff, time: new Date().toISOString()});
      if(logs.length > 50) logs = logs.slice(0,50);
      localStorage.setItem('careLoginLogs', JSON.stringify(logs));
    }
    // è‡ªå‹•ãƒ­ãƒƒã‚¯ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
    resetAutoLockTimer();
    // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã¯å¿…ãšè¨˜éŒ²å…¥åŠ›ãƒšãƒ¼ã‚¸ã«æˆ»ã™ï¼ˆç®¡ç†è€…ãŒé–‹ã„ã¦ã„ãŸãƒšãƒ¼ã‚¸ã‚’å¼•ãç¶™ãŒã›ãªã„ï¼‰
    document.querySelectorAll('.page').forEach(function(p){ p.classList.remove('on'); });
    document.querySelectorAll('.nav-btn').forEach(function(b){ b.classList.remove('on'); });
    var recPage = document.getElementById('page-rec');
    if(recPage) recPage.classList.add('on');
    // æœ€åˆã®nav-btnï¼ˆè¨˜éŒ²å…¥åŠ›ï¼‰ã«onä»˜ä¸
    var allNavBtns2 = document.querySelectorAll('.nav-btn');
    if(allNavBtns2.length > 0) allNavBtns2[0].classList.add('on');
    toast('âœ… '+(currentLoginStaff ? currentLoginStaff+'ã•ã‚“ã€' : '')+'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼'+(isAdmin(currentLoginStaff) ? ' ğŸ‘‘' : ''));
  } else {
    document.getElementById('perr').textContent = 'âŒ PINã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';
    pinBuf = '';
    updDots();
    var c = document.getElementById('pin-card');
    c.classList.remove('shake');
    void c.offsetWidth;
    c.classList.add('shake');
    setTimeout(function(){ c.classList.remove('shake'); }, 400);
  }
}
function lockScreen(){
  clearTimeout(_lockTimer);
  clearTimeout(_lockWarnTimer);
  dismissLockWarning();
  pinBuf = '';
  updDots();
  currentLoginStaff = '';
  sessionStorage.removeItem('careLoginStaff');
  document.getElementById('perr').textContent = '';
  // ç®¡ç†è€…å°‚ç”¨ãƒœã‚¿ãƒ³ã‚’å…¨ã¦éè¡¨ç¤º
  var settingsBtn  = document.getElementById('nav-settings-btn');
  var staffNavBtn  = document.getElementById('nav-staff-btn');
  var staffEditBtn = document.getElementById('staff-edit-btn');
  if(settingsBtn)  settingsBtn.style.display  = 'none';
  if(staffNavBtn)  staffNavBtn.style.display  = 'none';
  if(staffEditBtn) staffEditBtn.style.display = 'none';
  // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆï¼ˆå‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨æƒ…å ±ã‚’æ¶ˆå»ï¼‰
  clearFormFields(false);  // false = æ‹…å½“è€…ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ç¨®åˆ¥ã‚‚ç©ºã«ã™ã‚‹
  // ç”Ÿæˆçµæœã‚‚ã‚¯ãƒªã‚¢
  var outEl = document.getElementById('out');
  if(outEl){ outEl.textContent=''; outEl.classList.remove('on'); }
  var outBtns = document.getElementById('out-btns');
  if(outBtns) outBtns.style.display='none';
  var outEmpty = document.getElementById('out-empty');
  if(outEmpty) outEmpty.style.display='';
  // ãƒŠãƒ“åå‰ã‚‚ãƒªã‚»ãƒƒãƒˆ
  var ln = document.getElementById('login-name');
  if(ln) ln.textContent = 'â€”';
  // STEP1ã«æˆ»ã™
  document.getElementById('pin-step1').style.display = 'block';
  document.getElementById('pin-step2').style.display = 'none';
  document.getElementById('pin-screen').style.display = 'flex';
  renderLoginStaffList();
}

// ===== PINå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« =====
function openPinModal(){
  var me = STAFF_DATA.find(function(s){ return s.name === currentLoginStaff; });
  if(!me){ toast('âš ï¸ ã¾ãšãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  document.getElementById('pin-modal').dataset.targetIdx = STAFF_DATA.indexOf(me);
  document.getElementById('pin-modal-who').textContent = 'ğŸ”‘ ã€Œ'+me.name+'ã€ã®PINã‚’å¤‰æ›´';
  document.getElementById('pm-current').value = '';
  document.getElementById('pm-new').value = '';
  document.getElementById('pm-confirm').value = '';
  document.getElementById('pm-err').textContent = '';
  document.getElementById('pin-modal').classList.add('on');
}

function closePinModal(e){
  if(e.target === document.getElementById('pin-modal'))
    document.getElementById('pin-modal').classList.remove('on');
}

function savePinChange(){
  var idx = parseInt(document.getElementById('pin-modal').dataset.targetIdx);
  if(isNaN(idx) || !STAFF_DATA[idx]){ toast('ã‚¨ãƒ©ãƒ¼ï¼šã‚¹ã‚¿ãƒƒãƒ•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  var target = STAFF_DATA[idx];
  var curInput = document.getElementById('pm-current').value.trim();
  var newPin   = document.getElementById('pm-new').value.trim();
  var confirm2 = document.getElementById('pm-confirm').value.trim();
  var errEl = document.getElementById('pm-err');
  // ç®¡ç†è€…ãŒä»–äººã®PINå¤‰æ›´ã™ã‚‹å ´åˆã¯è‡ªåˆ†ã®PINã§èªè¨¼
  var viewer = STAFF_DATA.find(function(s){ return s.name === currentLoginStaff; });
  if(!viewer){ errEl.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“'; return; }
  if(curInput !== viewer.pin){ errEl.textContent = 'âŒ ç¾åœ¨ã®PINãŒé•ã„ã¾ã™'; return; }
  if(!/^[0-9]{4}$/.test(newPin)){ errEl.textContent = 'âš ï¸ 4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
  if(newPin !== confirm2){ errEl.textContent = 'âŒ æ–°ã—ã„PINãŒä¸€è‡´ã—ã¾ã›ã‚“'; return; }
  STAFF_DATA[idx].pin = newPin;
  saveStaffs();
  document.getElementById('pin-modal').classList.remove('on');
  toast('âœ… ã€Œ'+target.name+'ã€ã®PINã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
}


// ===== ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒšãƒ¼ã‚¸ =====
function spAddStaff(){
  var nameInp = document.getElementById('sp-new-name');
  var roleSel = document.getElementById('sp-new-role');
  var name = nameInp.value.trim();
  var role = roleSel ? roleSel.value : 'staff';
  if(!name){ toast('âš ï¸ ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if(STAFF_DATA.find(function(s){ return s.name===name; })){ toast('âš ï¸ ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™'); return; }
  STAFF_DATA.push({name:name, pin:'1234', role:role});
  saveStaffs();
  refreshStaffSelect();
  renderLoginStaffList();
  renderStaffPage();
  nameInp.value = '';
  toast('âœ… '+name+' ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆåˆæœŸPIN: 1234ï¼‰');
}

function renderStaffPage(){
  // ã‚¹ã‚¿ãƒƒãƒ•æ•°ãƒãƒƒã‚¸
  var countEl = document.getElementById('sp-staff-count');
  if(countEl) countEl.textContent = STAFF_DATA.length + 'åç™»éŒ²';

  // ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ã‚µãƒãƒª
  var logs = JSON.parse(localStorage.getItem('careLoginLogs')||'[]');
  var sumEl = document.getElementById('sp-login-summary');
  if(sumEl){
    if(!logs.length){
      sumEl.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ãªã—';
    } else {
      var last = logs[0];
      var dt = new Date(last.time);
      var ds = (dt.getMonth()+1)+'/'+dt.getDate()+' '+String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0');
      sumEl.innerHTML = 'ğŸ• æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³: <strong>'+last.name+'</strong> ã•ã‚“ï¼ˆ'+ds+'ï¼‰ã€€ç·ãƒ­ã‚°ã‚¤ãƒ³å›æ•°: '+logs.length+'å›';
    }
  }

  // ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§
  var box = document.getElementById('sp-staff-list');
  if(!box) return;
  if(!STAFF_DATA.length){
    box.innerHTML = '<div style="text-align:center;padding:24px;color:#94a3b8;">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
    return;
  }

  // å„ã‚¹ã‚¿ãƒƒãƒ•ã®è¨˜éŒ²ä»¶æ•°é›†è¨ˆ
  var recCounts = {};
  DB.forEach(function(r){ if(r.staff) recCounts[r.staff]=(recCounts[r.staff]||0)+1; });

  box.innerHTML = STAFF_DATA.map(function(s,i){
    var isMe = s.name === currentLoginStaff;
    var roleBadge = s.role==='admin'
      ? '<span style="font-size:10px;background:#fef3c7;color:#b45309;padding:2px 8px;border-radius:10px;font-weight:700;">ğŸ‘‘ ç®¡ç†è€…</span>'
      : '<span style="font-size:10px;background:#f1f5f9;color:#64748b;padding:2px 8px;border-radius:10px;">ä¸€èˆ¬</span>';
    var meBadge = isMe ? '<span style="font-size:10px;background:#dcfce7;color:#15803d;padding:2px 8px;border-radius:10px;font-weight:700;">â— è‡ªåˆ†</span>' : '';
    var cnt = recCounts[s.name] || 0;

    return '<div style="border:1.5px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:10px;background:'+(isMe?'#f0fdf4':'#fafafa')+';">'
      +'<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap;">'
      +'<span style="font-size:15px;font-weight:700;">ğŸ‘¤ '+s.name+'</span>'
      +roleBadge+meBadge
      +'<span style="margin-left:auto;font-size:12px;color:var(--gray);">è¨˜éŒ² '+cnt+'ä»¶</span>'
      +'</div>'
      +'<div style="display:flex;gap:6px;flex-wrap:wrap;">'
      +'<button class="btn bg" style="padding:5px 12px;font-size:12px;" onclick="spEditName('+i+')">âœï¸ åå‰å¤‰æ›´</button>'
      +'<button class="btn" style="padding:5px 12px;font-size:12px;background:#eff6ff;color:#2563eb;border-color:#bfdbfe;" onclick="spChangePIN('+i+')">ğŸ”‘ PINå¤‰æ›´</button>'
      +'<button class="btn" style="padding:5px 12px;font-size:12px;background:#f0fdf4;color:#15803d;border-color:#86efac;" onclick="spToggleRole('+i+')">'+(s.role==='admin'?'â¬‡ ä¸€èˆ¬ã«å¤‰æ›´':'â¬† ç®¡ç†è€…ã«æ˜‡æ ¼')+'</button>'
      +(STAFF_DATA.length > 1 ? '<button class="btn" style="padding:5px 12px;font-size:12px;background:var(--redbg);color:var(--red);" onclick="spDelete('+i+')">ğŸ—‘ å‰Šé™¤</button>' : '')
      +'</div>'
      +'</div>';
  }).join('');

  // ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ä¸€è¦§
  var logEl = document.getElementById('sp-login-log');
  if(logEl){
    if(!logs.length){
      logEl.innerHTML = '<div style="text-align:center;padding:16px;color:#94a3b8;font-size:13px;">ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    } else {
      logEl.innerHTML = logs.slice(0,10).map(function(l){
        var dt = new Date(l.time);
        var ds = dt.getFullYear()+'/'+(dt.getMonth()+1)+'/'+dt.getDate()+' '+String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0');
        var isAdm = STAFF_DATA.find(function(s){ return s.name===l.name && s.role==='admin'; });
        return '<div style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);font-size:12.5px;">'
          +'<span style="color:#94a3b8;min-width:110px;">'+ds+'</span>'
          +'<strong>'+l.name+'</strong>'
          +(isAdm?'<span style="font-size:10px;background:#fef3c7;color:#b45309;padding:1px 6px;border-radius:8px;">ğŸ‘‘</span>':'')
          +'</div>';
      }).join('');
    }
  }
}

function spEditName(idx){
  var s = STAFF_DATA[idx];
  var newName = prompt('æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', s.name);
  if(!newName || !newName.trim()) return;
  var old = s.name;
  STAFF_DATA[idx].name = newName.trim();
  if(currentLoginStaff === old) currentLoginStaff = newName.trim();
  saveStaffs(); refreshStaffSelect(); renderLoginStaffList(); renderStaffPage();
  toast('âœ… åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
}

function spChangePIN(idx){
  changeStaffPin(idx);
}

function spToggleRole(idx){
  if(!isAdmin(currentLoginStaff)){ toast('âš ï¸ ç®¡ç†è€…ã®ã¿å¤‰æ›´ã§ãã¾ã™'); return; }
  var s = STAFF_DATA[idx];
  // ç®¡ç†è€…ãŒè‡ªåˆ†1äººã®å ´åˆã¯é™æ ¼ã‚’ç¦æ­¢
  if(s.role==='admin'){
    var adminCount = STAFF_DATA.filter(function(x){ return x.role==='admin'; }).length;
    if(adminCount <= 1){ toast('âš ï¸ ç®¡ç†è€…ã¯æœ€ä½1åå¿…è¦ã§ã™'); return; }
  }
  STAFF_DATA[idx].role = (s.role==='admin') ? 'staff' : 'admin';
  saveStaffs(); renderStaffPage(); renderLoginStaffList();
  toast('âœ… ãƒ­ãƒ¼ãƒ«ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
}

function spDelete(idx){
  var s = STAFF_DATA[idx];
  if(s.name === currentLoginStaff){ toast('âš ï¸ è‡ªåˆ†è‡ªèº«ã¯å‰Šé™¤ã§ãã¾ã›ã‚“'); return; }
  if(!confirm('ã€Œ'+s.name+'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;
  STAFF_DATA.splice(idx,1);
  saveStaffs(); refreshStaffSelect(); renderLoginStaffList(); renderStaffPage();
  toast('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ');
}

// ===== ãƒšãƒ¼ã‚¸åˆ‡æ›¿ =====
function sp(id, el){
  document.querySelectorAll('.page').forEach(function(p){ p.classList.remove('on'); });
  document.querySelectorAll('.nav-btn').forEach(function(b){ b.classList.remove('on'); });
  // ç®¡ç†è¨­å®šãƒšãƒ¼ã‚¸ã¯ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯
  if((id === 'settings' || id === 'staff') && !isAdmin(currentLoginStaff)){
    toast('âš ï¸ ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™'); return;
  }
  document.getElementById('page-'+id).classList.add('on');
  if(el) el.classList.add('on');
  if(id==='dash') updDash();
  if(id==='list') renderList();
  if(id==='settings'){
    loadSettingsUI();
    document.getElementById('settings-admin-name').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­: '+currentLoginStaff+' ğŸ‘‘ç®¡ç†è€…';
  }
  if(id==='staff'){
    renderStaffPage();
    document.getElementById('staff-page-admin-name').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­: '+currentLoginStaff+' ğŸ‘‘ç®¡ç†è€…';
  }
}

// ===== å…¥åŠ›ã‚¿ãƒ–åˆ‡æ›¿ =====
function sit(id, el){
  document.querySelectorAll('.itab').forEach(function(t){ t.classList.remove('on'); });
  document.querySelectorAll('.ipane').forEach(function(p){ p.classList.remove('on'); });
  if(el) el.classList.add('on');
  document.getElementById('ip-'+id).classList.add('on');
}

// ===== ãƒã‚¤ã‚¿ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆå…¨é …ç›®ï¼‰ =====
function checkV(){
  var t    = parseFloat(document.getElementById('f-temp').value);
  var s    = parseInt(document.getElementById('f-spo2').value);
  var bpRaw= document.getElementById('f-bp').value.trim();
  var p    = parseInt(document.getElementById('f-pulse').value);
  var h = '';

  // ä½“æ¸©
  if(t >= 37.5)       h += '<span class="vc vc-r">âš  ä½“æ¸© '+t+'â„ƒ ç™ºç†±ã®å¯èƒ½æ€§</span>';
  else if(t >= 37.0)  h += '<span class="vc vc-y">âš¡ ä½“æ¸© '+t+'â„ƒ ã‚„ã‚„é«˜ã‚</span>';
  else if(t >= 36.0)  h += '<span class="vc vc-g">âœ… ä½“æ¸© æ­£å¸¸ç¯„å›²</span>';
  else if(t > 0)      h += '<span class="vc vc-y">âš¡ ä½“æ¸© '+t+'â„ƒ ã‚„ã‚„ä½ã‚</span>';

  // è¡€åœ§
  var bpMatch = bpRaw.match(/(\d+)[\/](\d+)/);
  if(bpMatch){
    var sys = parseInt(bpMatch[1]), dia = parseInt(bpMatch[2]);
    if(sys >= 180 || dia >= 110)      h += '<span class="vc vc-r">âš  è¡€åœ§ '+bpRaw+' é«˜è¡€åœ§ç·Šæ€¥ç—‡ãƒ¬ãƒ™ãƒ«</span>';
    else if(sys >= 140 || dia >= 90)  h += '<span class="vc vc-y">âš¡ è¡€åœ§ '+bpRaw+' é«˜è¡€åœ§ï¼ˆè¦æ³¨æ„ï¼‰</span>';
    else if(sys < 90  || dia < 60)    h += '<span class="vc vc-r">âš  è¡€åœ§ '+bpRaw+' ä½è¡€åœ§</span>';
    else                               h += '<span class="vc vc-g">âœ… è¡€åœ§ æ­£å¸¸ç¯„å›²</span>';
  }

  // è„ˆæ‹
  if(p > 0){
    if(p > 100)       h += '<span class="vc vc-y">âš¡ è„ˆæ‹ '+p+'å›/åˆ† é »è„ˆ</span>';
    else if(p < 50)   h += '<span class="vc vc-r">âš  è„ˆæ‹ '+p+'å›/åˆ† å¾è„ˆï¼ˆè¦æ³¨æ„ï¼‰</span>';
    else if(p < 60)   h += '<span class="vc vc-y">âš¡ è„ˆæ‹ '+p+'å›/åˆ† ã‚„ã‚„ä½ã‚</span>';
    else              h += '<span class="vc vc-g">âœ… è„ˆæ‹ æ­£å¸¸ç¯„å›²</span>';
  }

  // SpO2
  if(s > 0){
    if(s < 90)         h += '<span class="vc vc-r">âš  SpO2 '+s+'% è¦æ³¨æ„</span>';
    else if(s < 95)    h += '<span class="vc vc-y">âš¡ SpO2 '+s+'% ã‚„ã‚„ä½ä¸‹</span>';
    else               h += '<span class="vc vc-g">âœ… SpO2 æ­£å¸¸ç¯„å›²</span>';
  }

  document.getElementById('v-alerts').innerHTML = h;
}

// ===== éŸ³å£°å…¥åŠ› =====
function toggleVoice(){
  var btn = document.getElementById('vbtn');
  var ri  = document.getElementById('ri');
  if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)){
    toast('âš ï¸ Chrome/Edgeã‚’ãŠä½¿ã„ãã ã•ã„');
    return;
  }
  if(recOn){
    recog.stop(); recOn = false;
    btn.innerHTML = 'ğŸ¤ éŸ³å£°å…¥åŠ› é–‹å§‹';
    btn.className = 'btn bd';
    ri.style.display = 'none';
    // éŸ³å£°åœæ­¢æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    updateMemoPreview();
    return;
  }
  var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recog = new SR();
  recog.lang = 'ja-JP';
  recog.continuous = true;
  recog.interimResults = true;
  var final = document.getElementById('f-memo').value;
  recog.onresult = function(e){
    var interim = '';
    for(var i = e.resultIndex; i < e.results.length; i++){
      if(e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    document.getElementById('f-memo').value = final + interim;
  };
  recog.onerror = function(){ recOn=false; btn.innerHTML='ğŸ¤ éŸ³å£°å…¥åŠ› é–‹å§‹'; btn.className='btn bd'; ri.style.display='none'; };
  recog.onend   = function(){ if(recOn) recog.start(); };
  recog.start();
  recOn = true;
  btn.innerHTML = 'â¹ åœæ­¢';
  btn.className = 'btn bg';
  ri.style.display = 'flex';
}

// ===== ãƒ¡ãƒ¢è§£æãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ =====
function updateMemoPreview(){
  var text = document.getElementById('f-memo').value.trim();
  if(!text){ document.getElementById('memo-preview').style.display='none'; return; }
  
  var parsed = parseMemo(text);
  var items = [
    {label:'ğŸ‘¤ åˆ©ç”¨è€…å', val: parsed.name !== 'ï¼ˆç¢ºèªè¦ï¼‰'},
    {label:'ğŸŒ¡ï¸ ä½“æ¸©',    val: !!parsed.temp},
    {label:'â¤ï¸ è¡€åœ§',    val: !!parsed.bp},
    {label:'ğŸ’“ è„ˆæ‹',    val: !!parsed.pulse},
    {label:'ğŸ©¸ SpO2',    val: !!parsed.spo2},
    {label:'ğŸ± é£Ÿäº‹',    val: !!parsed.meal},
    {label:'ğŸ’§ æ°´åˆ†',    val: !!parsed.water},
    {label:'ğŸš¿ å…¥æµ´',    val: !!parsed.bath},
    {label:'ğŸš½ æ’æ³„',    val: !!parsed.toilet},
    {label:'ğŸš¶ ç§»å‹•',    val: !!parsed.walk},
    {label:'ğŸ˜Š æ§˜å­',    val: !!parsed.mood}
    // â€»æ‹…å½“è€…ã¯ãƒ­ã‚°ã‚¤ãƒ³ã‚¹ã‚¿ãƒƒãƒ•ã‹ã‚‰è‡ªå‹•åæ˜ ã™ã‚‹ãŸã‚è§£æãƒã‚§ãƒƒã‚¯ä¸è¦
  ];
  
  var html = items.map(function(item){
    var cls = item.val ? 'ok' : 'ng';
    var icon = item.val ? 'âœ“' : 'âœ—';
    return '<span class="vci '+cls+'">'+icon+' '+item.label+'</span>';
  }).join('');
  
  document.getElementById('vc-check-items').innerHTML = html;
  document.getElementById('memo-preview').style.display = 'block';
}

// f-memoã®inputã‚¤ãƒ™ãƒ³ãƒˆã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
document.addEventListener('DOMContentLoaded', function(){
  document.getElementById('f-memo').addEventListener('input', function(){
    if(this.value.trim()) updateMemoPreview();
    else document.getElementById('memo-preview').style.display='none';
  });
});

// ===== ãƒ¡ãƒ¢è§£æï¼ˆå…±é€šé–¢æ•°ï¼‰ =====
function parseMemo(text){
  var result = {
    name:'ï¼ˆç¢ºèªè¦ï¼‰', staff:'ï¼ˆç¢ºèªè¦ï¼‰',
    temp:'', bp:'', pulse:'', spo2:'',
    meal:'', water:'', bath:'', toilet:'', walk:'', mood:''
  };
  
  // åˆ©ç”¨è€…å
  var nm = text.match(/([^\sã€ã€‚,ã€€]+)(ã•ã‚“|æ§˜)/);
  if(nm) result.name = nm[1]+nm[2];

  // æ‹…å½“
  var sfm = text.match(/æ‹…å½“[ã¯ãŒï¼š:ã€€\s]*([^\sã€ã€‚,ã€€]+)/);
  if(sfm) result.staff = sfm[1];

  // ä½“æ¸©
  var tm = text.match(/ä½“æ¸©[\s:ï¼š]*([\d.]+)|(3[5-9]\.\d)/);
  if(tm) result.temp = tm[1]||tm[2];

  // è¡€åœ§ï¼ˆã€Œ120ã®75ã€ã€Œ120/75ã€ã€Œ120-75ã€å¯¾å¿œï¼‰
  var bm = text.match(/è¡€åœ§[\s:ï¼š]*([\d]+)[ã®toãƒ\/\s\-]+([\d]+)/);
  if(bm) result.bp = bm[1]+'/'+bm[2];

  // è„ˆæ‹
  var pm = text.match(/è„ˆæ‹[\s:ï¼š]*([\d]+)/);
  if(pm) result.pulse = pm[1];

  // SpO2ï¼ˆå¼·åŒ–ç‰ˆ: SP98, SPO2ã¯98, SpO2 98%, é…¸ç´ 98, ã•ã‚“ã98 ç­‰å¯¾å¿œï¼‰
  var sm = text.match(/[Ss][Pp][Oo0][23][\s:ï¼šã¯]*([\d]{2,3})/);        // SpO2, Sp02, spo2
  if(!sm) sm = text.match(/[Ss][Pp]\s*[Oo0]\s*2[\s:ï¼šã¯]*([\d]{2,3})/); // S P O 2 (ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Š)
  if(!sm) sm = text.match(/ã‚µãƒãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³[\s:ï¼šã¯]*([\d]{2,3})/);
  if(!sm) sm = text.match(/é…¸ç´ [é£½å’Œåº¦æ¿ƒåº¦]*[\s:ï¼šã¯]*([89][\d]|100)/);
  if(!sm) sm = text.match(/ã•ã‚“ã[\s:ï¼šã¯]*([\d]{2,3})/);
  // %ä»˜ãæ•°å€¤ï¼ˆ96%, 97% ãªã© - å‰å¾Œã®æ–‡è„ˆã§ãƒã‚¤ã‚¿ãƒ«ã£ã½ã„æ•°å€¤ï¼‰
  if(!sm){
    var pctM = text.match(/([9][0-9]|100)\s*%(?![^]*\d{2,3}\s*[/åˆ†])/);
    if(pctM) sm = pctM;
  }
  // ã€ŒSpO2ã¯æ­£å¸¸ã€ã®å¾Œã«æ•°å€¤ãŒã‚ã‚‹å ´åˆ
  if(!sm) sm = text.match(/[Ss][Pp][Oo0]?2?\s*(?:ã¯|ãŒ|ï¼|=)?\s*([8-9][\d]|100)/);
  // æ•°å€¤ãŒ70-100ã®ç¯„å›²ã«ã‚ã‚‹ã‚‚ã®ã ã‘æ¡ç”¨
  if(sm && parseInt(sm[1]) >= 70 && parseInt(sm[1]) <= 100) result.spo2 = sm[1];

  // ===== é£Ÿäº‹ï¼ˆå¼·åŒ–ç‰ˆï¼‰ =====
  if(text.match(/å…¨é‡|å…¨éƒ¨é£Ÿã¹|å®Œé£Ÿ/)) result.meal='å…¨é‡æ‘‚å–';
  else if(text.match(/[89]å‰²/)) result.meal='8å‰²ç¨‹åº¦æ‘‚å–';
  else if(text.match(/åŠé‡|5å‰²|åŠåˆ†/)) result.meal='åŠé‡æ‘‚å–';
  else if(text.match(/[23]å‰²/)) result.meal='3å‰²ç¨‹åº¦æ‘‚å–';
  else if(text.match(/é£Ÿã¹ã¦ã„ãªã„|é£Ÿã¹ã¦ãªã„|ã»ã¨ã‚“ã©é£Ÿã¹|ã»ã¼é£Ÿã¹|é£Ÿæ¬²ãª|é£Ÿã¹ã‚‰ã‚Œ/)) result.meal='ã»ã¼æ‘‚å–ã§ããš';
  else if(text.match(/ã‚ã¾ã‚Šé£Ÿã¹|å°‘ã—ã—ã‹é£Ÿã¹|ãã‚Œã»ã©é£Ÿã¹|ã‚ã¾ã‚Šæ‘‚|å°‘é‡æ‘‚/)) result.meal='å°‘é‡æ‘‚å–';
  else if(text.match(/ã‚ˆãé£Ÿã¹|ã—ã£ã‹ã‚Šé£Ÿã¹|é£Ÿäº‹.*è‰¯å¥½|ãŸãã•ã‚“é£Ÿã¹/)) result.meal='å…¨é‡æ‘‚å–';
  else if(text.match(/é£Ÿäº‹/)) result.meal='æ‘‚å–ï¼ˆé‡è¦ç¢ºèªï¼‰';

  // ===== æ°´åˆ†ï¼ˆæ–°è¦è¿½åŠ ï¼‰ =====
  if(text.match(/æ°´åˆ†.*ååˆ†|æ°´åˆ†.*ã—ã£ã‹ã‚Š|ãŸãã•ã‚“é£²|æ°´åˆ†.*ã‚ˆã|æ°´åˆ†.*å•é¡Œ/)) result.water='ååˆ†æ‘‚å–';
  else if(text.match(/æ°´åˆ†.*å°‘|æ°´åˆ†.*ã‚ã¾ã‚Š|é£²ã‚“ã§ã„ãªã„|æ°´åˆ†.*æ‹’å¦|æ°´åˆ†.*ãªã„/)) result.water='å°‘é‡æ‘‚å–';
  else if(text.match(/æ°´åˆ†/)) result.water='æ‘‚å–ç¢ºèª';

  // ===== å…¥æµ´ï¼ˆå¼·åŒ–ç‰ˆï¼‰ =====
  if(text.match(/å…¥æµ´.*è‡ªåˆ†|è‡ªåˆ†.*å…¥æµ´|å…¥æµ´.*è‡ªç«‹|è‡ªç«‹.*å…¥æµ´|è‡ªåŠ›.*å…¥æµ´|ä¸€äººã§å…¥æµ´/)) result.bath='è‡ªç«‹å…¥æµ´ï¼ˆå•é¡Œãªã—ï¼‰';
  else if(text.match(/å…¥æµ´.*ä»‹åŠ©|ä»‹åŠ©.*å…¥æµ´|å…¥æµ´.*å•é¡Œãªã—|å…¥æµ´.*å®Ÿæ–½/)) result.bath='å…¥æµ´ä»‹åŠ©å®Ÿæ–½ï¼ˆå•é¡Œãªã—ï¼‰';
  else if(text.match(/ã‚·ãƒ£ãƒ¯ãƒ¼/)) result.bath='ã‚·ãƒ£ãƒ¯ãƒ¼æµ´å®Ÿæ–½';
  else if(text.match(/æ¸…æ‹­/)) result.bath='æ¸…æ‹­å®Ÿæ–½';
  else if(text.match(/å…¥æµ´ãªã—|å…¥æµ´.*ãªã—|ãŠé¢¨å‘‚.*ãªã—/)) result.bath='æœ¬æ—¥ã¯å…¥æµ´ãªã—';
  else if(text.match(/å…¥æµ´|ãŠé¢¨å‘‚/)) result.bath='å…¥æµ´å®Ÿæ–½';

  // ===== æ’æ³„ï¼ˆå¼·åŒ–ç‰ˆï¼‰ =====
  if(text.match(/æ’æ³„.*è‡ªåˆ†|è‡ªåˆ†.*æ’æ³„|æ’æ³„.*è‡ªç«‹|è‡ªç«‹.*æ’æ³„|è‡ªåŠ›.*æ’æ³„|ãƒˆã‚¤ãƒ¬.*è‡ªåˆ†|è‡ªåˆ†.*ãƒˆã‚¤ãƒ¬|æ’æ³„.*è‡ªåŠ›ã§ã§ãã¦|ãƒˆã‚¤ãƒ¬.*è‡ªåŠ›/)) result.toilet='è‡ªç«‹æ’æ³„ï¼ˆå•é¡Œãªã—ï¼‰';
  else if(text.match(/ä¸€éƒ¨ä»‹åŠ©|éƒ¨åˆ†ä»‹åŠ©/)) result.toilet='ä¸€éƒ¨ä»‹åŠ©ã«ã¦æ’æ³„';
  else if(text.match(/å…¨ä»‹åŠ©/)) result.toilet='å…¨ä»‹åŠ©ã«ã¦æ’æ³„';
  else if(text.match(/ã‚ªãƒ ãƒ„|ãŠã‚€ã¤/)) result.toilet='ã‚ªãƒ ãƒ„äº¤æ›å®Ÿæ–½';
  else if(text.match(/ãƒˆã‚¤ãƒ¬|æ’æ³„/)) result.toilet='æ’æ³„ä»‹åŠ©å®Ÿæ–½';

  // ===== ç§»å‹•ï¼ˆå¼·åŒ–ç‰ˆï¼‰ =====
  if(text.match(/è‡ªç«‹æ­©è¡Œ|è‡ªåŠ›æ­©è¡Œ|è‡ªåˆ†ã§æ­©|æ­©è¡Œ.*å•é¡Œãªã—|è‡ªåŠ›.*ç§»å‹•|ç§»å‹•.*è‡ªåŠ›|è‡ªåŠ›å¯èƒ½|è‡ªåŠ›ã§ç§»/)) result.walk='è‡ªç«‹æ­©è¡Œï¼ˆå•é¡Œãªã—ï¼‰';
  else if(text.match(/æ­©è¡Œå™¨/)) result.walk='æ­©è¡Œå™¨ä½¿ç”¨ã«ã¦ç§»å‹•';
  else if(text.match(/è»Šæ¤…å­|è»Šã„ã™|è»Šã‚¤ã‚¹/)) result.walk='è»Šæ¤…å­ã«ã¦ç§»å‹•';
  else if(text.match(/ç§»å‹•.*å…¨ä»‹åŠ©|å…¨ä»‹åŠ©.*ç§»å‹•/)) result.walk='å…¨ä»‹åŠ©ã«ã¦ç§»å‹•';
  else if(text.match(/ç§»å‹•/)) result.walk='ç§»å‹•ï¼ˆæ–¹æ³•è¦ç¢ºèªï¼‰';

  // ===== æ§˜å­ï¼ˆå¼·åŒ–ç‰ˆï¼‰ =====
  if(text.match(/ç¬‘é¡”|å…ƒæ°—|è‰¯å¥½|å–œ|æ¥½ã—|å¬‰ã—/)) result.mood='ç¬‘é¡”ãŒè¦‹ã‚‰ã‚Œè‰¯å¥½';
  else if(text.match(/ç©ã‚„ã‹|è½ã¡ç€|å®‰å®š/)) result.mood='ç©ã‚„ã‹ã§å®‰å®šã—ãŸçŠ¶æ…‹';
  else if(text.match(/çœ |å‚¾çœ |ã†ã¨ã†ã¨/)) result.mood='å‚¾çœ å‚¾å‘ãŒè¦‹ã‚‰ã‚ŒãŸ';
  else if(text.match(/ä¸ç©|èˆˆå¥®/)) result.mood='ä¸ç©ãƒ»èˆˆå¥®ã®æ§˜å­ãŒè¦‹ã‚‰ã‚ŒãŸ';
  else if(text.match(/å…ƒæ°—ãŒãª|ä¸èª¿|å…·åˆ|ã—ã‚“ã©|ã—ã‚“ã©ãã†/)) result.mood='ã‚„ã‚„å…ƒæ°—ãŒãªã„æ§˜å­';
  else if(text.match(/æ°—ã«ãªã‚‹äº‹ã¯ç„¡|å•é¡Œãªã—|ç‰¹ã«å¤‰åŒ–ãªã—/)) result.mood='ç©ã‚„ã‹ã§å®‰å®šã—ãŸçŠ¶æ…‹';

  return result;
}

// ===== AIè¨˜éŒ²ç”Ÿæˆ =====
function generate(){
  var active = document.querySelector('.ipane.on').id;
  var load = document.getElementById('gen-load');
  load.classList.add('on');
  setTimeout(function(){
    var rec;
    if(active === 'ip-form'){
      rec = genFromForm();
    } else {
      var memo = document.getElementById('f-memo').value.trim();
      if(!memo){ load.classList.remove('on'); toast('âš ï¸ ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      rec = genFromMemo(memo);
    }
    load.classList.remove('on');
    if(rec) showOut(rec);
  }, 700);
}

function gv(id){ return document.getElementById(id).value; }

function genFromForm(){
  var name = gv('f-name').trim();
  if(!name){ toast('âš ï¸ åˆ©ç”¨è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return null; }
  var dt = new Date(gv('f-dt') || Date.now());
  var ds = dt.getFullYear()+'å¹´'+(dt.getMonth()+1)+'æœˆ'+dt.getDate()+'æ—¥';
  var ts = String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0');
  var staff = gv('f-staff') || 'ï¼ˆæœªå…¥åŠ›ï¼‰';
  var temp=gv('f-temp'), bp=gv('f-bp'), pulse=gv('f-pulse'), spo2=gv('f-spo2');

  var L = [];
  L.push('ã€ä»‹è­·æ—¥å¸¸è¨˜éŒ²ã€‘');
  L.push('è¨˜éŒ²æ—¥æ™‚ï¼š'+ds+' '+ts);
  L.push('åˆ©ç”¨è€…åï¼š'+name);
  L.push('æ‹…å½“è·å“¡ï¼š'+staff);
  L.push('ã‚µãƒ¼ãƒ“ã‚¹ï¼š'+gv('f-svc'));
  L.push('');

  var vt = [];
  if(temp)  vt.push('ä½“æ¸© '+temp+'â„ƒ');
  if(bp)    vt.push('è¡€åœ§ '+bp+'mmHg');
  if(pulse) vt.push('è„ˆæ‹ '+pulse+'å›/åˆ†');
  if(spo2)  vt.push('SpO2 '+spo2+'%');
  if(vt.length){ L.push('â–  ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³'); L.push(vt.join('ã€€/ã€€')); }

  // è¦æ³¨æ„ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆä½“æ¸©ãƒ»è¡€åœ§ãƒ»è„ˆæ‹ãƒ»SpO2ï¼‰
  var al = [];
  if(temp  && parseFloat(temp) >= 37.5)   al.push('âš  ä½“æ¸© '+temp+'â„ƒï¼ˆç™ºç†±ã®å¯èƒ½æ€§ï¼‰');
  var bpM = bp ? bp.match(/(\d+)[\/](\d+)/) : null;
  if(bpM){
    var sys=parseInt(bpM[1]),dia=parseInt(bpM[2]);
    if(sys>=180||dia>=110) al.push('âš  è¡€åœ§ '+bp+'mmHgï¼ˆé«˜è¡€åœ§ç·Šæ€¥ç—‡ãƒ¬ãƒ™ãƒ«ï¼‰');
    else if(sys>=140||dia>=90) al.push('âš  è¡€åœ§ '+bp+'mmHgï¼ˆé«˜è¡€åœ§ãƒ»è¦æ³¨æ„ï¼‰');
    else if(sys<90||dia<60) al.push('âš  è¡€åœ§ '+bp+'mmHgï¼ˆä½è¡€åœ§ï¼‰');
  }
  var pNum = pulse ? parseInt(pulse) : 0;
  if(pNum > 100) al.push('âš  è„ˆæ‹ '+pulse+'å›/åˆ†ï¼ˆé »è„ˆï¼‰');
  else if(pNum > 0 && pNum < 50) al.push('âš  è„ˆæ‹ '+pulse+'å›/åˆ†ï¼ˆå¾è„ˆï¼‰');
  if(spo2  && parseInt(spo2) < 95 && parseInt(spo2) > 0) al.push('âš  SpO2 '+spo2+'%ï¼ˆä½ä¸‹ã«æ³¨æ„ï¼‰');
  if(al.length){ L.push(''); L.push('âš ï¸ è¦æ³¨æ„äº‹é …'); al.forEach(function(a){ L.push(a); }); }

  L.push(''); L.push('â–  æ—¥å¸¸ã‚±ã‚¢è¨˜éŒ²');
  if(gv('f-meal'))   L.push('ãƒ»é£Ÿäº‹ï¼š'+gv('f-meal'));
  if(gv('f-water'))  L.push('ãƒ»æ°´åˆ†ï¼š'+gv('f-water'));
  if(gv('f-bath'))   L.push('ãƒ»å…¥æµ´ï¼š'+gv('f-bath'));
  if(gv('f-toilet')) L.push('ãƒ»æ’æ³„ï¼š'+gv('f-toilet'));
  if(gv('f-walk'))   L.push('ãƒ»ç§»å‹•ï¼š'+gv('f-walk'));
  if(gv('f-mood'))   L.push('ãƒ»æ§˜å­ï¼š'+gv('f-mood'));

  var note = gv('f-note').trim();
  if(note){ L.push(''); L.push('â–  ç‰¹è¨˜äº‹é …'); L.push(note); }

  L.push('');
  L.push('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  L.push('è¨˜éŒ²ä½œæˆï¼š'+staff+'ã€€ï¼ˆAIã‚¢ã‚·ã‚¹ãƒˆè¨˜éŒ²ï¼‰');
  return L.join('\n');
}

function genFromMemo(text){
  var now = new Date();
  var ds  = now.getFullYear()+'å¹´'+(now.getMonth()+1)+'æœˆ'+now.getDate()+'æ—¥';
  var ts  = String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');

  var p = parseMemo(text);

  var L = [];
  L.push('ã€ä»‹è­·æ—¥å¸¸è¨˜éŒ²ã€‘');
  L.push('è¨˜éŒ²æ—¥æ™‚ï¼š'+ds+' '+ts);
  L.push('åˆ©ç”¨è€…åï¼š'+p.name);
  // æ‹…å½“è€…ã¯ãƒ¡ãƒ¢æœªè¨˜è¼‰ã®å ´åˆã€é¸æŠæ¸ˆã¿ã®f-staffã‹ã‚‰è‡ªå‹•åæ˜ 
  var staffForRecord = (p.staff && p.staff !== 'ï¼ˆç¢ºèªè¦ï¼‰') ? p.staff : (gv('f-staff') || currentLoginStaff || 'ï¼ˆç¢ºèªè¦ï¼‰');
  L.push('æ‹…å½“è·å“¡ï¼š'+staffForRecord);
  L.push('');

  var vt = [];
  if(p.temp)  vt.push('ä½“æ¸© '+p.temp+'â„ƒ');
  if(p.bp)    vt.push('è¡€åœ§ '+p.bp+'mmHg');
  if(p.pulse) vt.push('è„ˆæ‹ '+p.pulse+'å›/åˆ†');
  if(p.spo2)  vt.push('SpO2 '+p.spo2+'%');
  if(vt.length){ L.push('â–  ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³'); L.push(vt.join('ã€€/ã€€')); L.push(''); }

  // ã‚¢ãƒ©ãƒ¼ãƒˆ
  var al = [];
  if(p.temp && parseFloat(p.temp) >= 37.5) al.push('âš  ä½“æ¸© '+p.temp+'â„ƒï¼ˆç™ºç†±ã®å¯èƒ½æ€§ï¼‰');
  if(p.bp){
    var bpM2 = p.bp.match(/(\d+)[\/](\d+)/);
    if(bpM2){
      var s2=parseInt(bpM2[1]),d2=parseInt(bpM2[2]);
      if(s2>=180||d2>=110) al.push('âš  è¡€åœ§ '+p.bp+'mmHgï¼ˆé«˜è¡€åœ§ç·Šæ€¥ç—‡ãƒ¬ãƒ™ãƒ«ï¼‰');
      else if(s2>=140||d2>=90) al.push('âš  è¡€åœ§ '+p.bp+'mmHgï¼ˆé«˜è¡€åœ§ãƒ»è¦æ³¨æ„ï¼‰');
      else if(s2<90||d2<60) al.push('âš  è¡€åœ§ '+p.bp+'mmHgï¼ˆä½è¡€åœ§ï¼‰');
    }
  }
  var pn = p.pulse ? parseInt(p.pulse) : 0;
  if(pn > 100) al.push('âš  è„ˆæ‹ '+p.pulse+'å›/åˆ†ï¼ˆé »è„ˆï¼‰');
  else if(pn > 0 && pn < 50) al.push('âš  è„ˆæ‹ '+p.pulse+'å›/åˆ†ï¼ˆå¾è„ˆï¼‰');
  if(p.spo2 && parseInt(p.spo2) < 95) al.push('âš  SpO2 '+p.spo2+'%ï¼ˆä½ä¸‹ã«æ³¨æ„ï¼‰');
  if(al.length){ L.push('âš ï¸ è¦æ³¨æ„äº‹é …'); al.forEach(function(a){ L.push(a); }); L.push(''); }

  L.push('â–  æ—¥å¸¸ã‚±ã‚¢è¨˜éŒ²');
  if(p.meal)   L.push('ãƒ»é£Ÿäº‹ï¼š'+p.meal);
  if(p.water)  L.push('ãƒ»æ°´åˆ†ï¼š'+p.water);
  if(p.bath)   L.push('ãƒ»å…¥æµ´ï¼š'+p.bath);
  if(p.toilet) L.push('ãƒ»æ’æ³„ï¼š'+p.toilet);
  if(p.walk)   L.push('ãƒ»ç§»å‹•ï¼š'+p.walk);
  if(p.mood)   L.push('ãƒ»æ§˜å­ï¼š'+p.mood);

  L.push(''); L.push('â–  å…¥åŠ›ãƒ¡ãƒ¢ï¼ˆåŸæ–‡å‚ç…§ï¼‰');
  L.push('"'+text+'"');
  L.push(''); L.push('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  L.push('ï¼ˆAIã‚¢ã‚·ã‚¹ãƒˆè¨˜éŒ² â€»å†…å®¹ã‚’å¿…ãšã”ç¢ºèªãã ã•ã„ï¼‰');

  // ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚‚åæ˜ 
  if(p.name !== 'ï¼ˆç¢ºèªè¦ï¼‰') document.getElementById('f-name').value = p.name.replace(/ã•ã‚“|æ§˜/,'');
  var staffSel = document.getElementById('f-staff');
  var staffFound = false;
  for(var i=0;i<staffSel.options.length;i++){
    if(staffSel.options[i].value === p.staff){ staffSel.value = p.staff; staffFound=true; break; }
  }
  if(p.temp)  document.getElementById('f-temp').value = p.temp;
  if(p.bp)    document.getElementById('f-bp').value = p.bp;
  if(p.pulse) document.getElementById('f-pulse').value = p.pulse;
  if(p.spo2)  document.getElementById('f-spo2').value = p.spo2;
  if(p.meal)   document.getElementById('f-meal').value = p.meal;
  if(p.water)  document.getElementById('f-water').value = p.water;
  if(p.bath)   document.getElementById('f-bath').value = p.bath;
  if(p.toilet) document.getElementById('f-toilet').value = p.toilet;
  if(p.walk)   document.getElementById('f-walk').value = p.walk;
  if(p.mood)   document.getElementById('f-mood').value = p.mood;
  checkV();

  return L.join('\n');
}

// ===== å‡ºåŠ› =====
function showOut(rec){
  document.getElementById('out').textContent = rec;
  document.getElementById('out').classList.add('on');
  document.getElementById('out-empty').style.display = 'none';
  document.getElementById('out-btns').style.display = 'block';
}
// ===== ãƒ•ã‚©ãƒ¼ãƒ å…¨ã‚¯ãƒªã‚¢ï¼ˆå·¦å´ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¨éƒ¨ãƒªã‚»ãƒƒãƒˆï¼‰ =====
function clearFormFields(keepStaff){
  // ãƒ†ã‚­ã‚¹ãƒˆãƒ»æ•°å€¤ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  ['f-name','f-temp','f-bp','f-pulse','f-spo2','f-note','f-memo'].forEach(function(id){
    var el = document.getElementById(id);
    if(el) el.value = '';
  });
  // ã‚»ãƒ¬ã‚¯ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  ['f-meal','f-water','f-bath','f-toilet','f-walk','f-mood'].forEach(function(id){
    var el = document.getElementById(id);
    if(el) el.value = '';
  });
  // ãƒã‚¤ã‚¿ãƒ«è­¦å‘Šã‚¯ãƒªã‚¢
  var va = document.getElementById('v-alerts');
  if(va) va.innerHTML = '';
  // ãƒ¡ãƒ¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤º
  var mp = document.getElementById('memo-preview');
  if(mp) mp.style.display = 'none';
  // æ—¥æ™‚ã‚’ç¾åœ¨æ™‚åˆ»ã«ãƒªã‚»ãƒƒãƒˆ
  var dtEl = document.getElementById('f-dt');
  if(dtEl){
    var now = new Date();
    dtEl.value = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')
      +'T'+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  }
  // æ‹…å½“è€…: keepStaffãŒfalse(lockScreen)ã®å ´åˆã¯ç©ºã€trueã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ã‚¹ã‚¿ãƒƒãƒ•ã‚’ä¿æŒ
  var staffSel = document.getElementById('f-staff');
  if(staffSel){
    if(keepStaff && currentLoginStaff){
      staffSel.value = currentLoginStaff;
    } else if(!keepStaff){
      staffSel.value = '';
    }
  }
  // ã‚µãƒ¼ãƒ“ã‚¹ç¨®åˆ¥: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‹ã‚‰å†ã‚»ãƒƒãƒˆï¼ˆä¿æŒæ™‚ã®ã¿ï¼‰
  if(keepStaff && APP_SETTINGS.defaultService){
    var svcSel = document.getElementById('f-svc');
    if(svcSel) svcSel.value = APP_SETTINGS.defaultService;
  } else if(!keepStaff){
    var svcSel2 = document.getElementById('f-svc');
    if(svcSel2) svcSel2.value = '';
  }
}

function clearOut(){
  // å·¦å´ãƒ•ã‚©ãƒ¼ãƒ ã‚‚å…¨ã‚¯ãƒªã‚¢ï¼ˆæ—¥æ™‚ãƒªã‚»ãƒƒãƒˆãƒ»æ‹…å½“è€…ã¯ãƒ­ã‚°ã‚¤ãƒ³ã‹ã‚‰å†ã‚»ãƒƒãƒˆï¼‰
  clearFormFields(true);
  // å³å´ç”Ÿæˆçµæœã‚‚ã‚¯ãƒªã‚¢
  document.getElementById('out').textContent = '';
  document.getElementById('out').classList.remove('on');
  document.getElementById('out-empty').style.display = 'block';
  document.getElementById('out-btns').style.display = 'none';
  toast('ğŸ—‘ ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
}
function copyRec(){
  var t = document.getElementById('out').textContent;
  if(!t){ toast('âš ï¸ å…ˆã«è¨˜éŒ²ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„'); return; }
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(t).then(function(){ toast('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); });
  } else {
    var ta = document.createElement('textarea');
    ta.value = t;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    toast('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  }
}

// ===== ä¿å­˜ =====
function saveRec(){
  var rec = document.getElementById('out').textContent;
  if(!rec){ toast('âš ï¸ å…ˆã«AIè¨˜éŒ²ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„'); return; }

  // ãƒã‚¤ã‚¿ãƒ«ã‚¢ãƒ©ãƒ¼ãƒˆåé›†ï¼ˆå…¨é …ç›®ï¼‰
  var al = [];
  var tv = parseFloat(gv('f-temp'));
  var sv = parseInt(gv('f-spo2'));
  var bpRaw2 = gv('f-bp').trim();
  var pv2 = parseInt(gv('f-pulse'));

  if(tv >= 37.5) al.push('ä½“æ¸© '+tv+'â„ƒï¼ˆç™ºç†±ã®å¯èƒ½æ€§ï¼‰');
  
  var bpM3 = bpRaw2.match(/(\d+)[\/](\d+)/);
  if(bpM3){
    var sy3=parseInt(bpM3[1]),di3=parseInt(bpM3[2]);
    if(sy3>=180||di3>=110) al.push('è¡€åœ§ '+bpRaw2+'mmHgï¼ˆé«˜è¡€åœ§ç·Šæ€¥ç—‡ãƒ¬ãƒ™ãƒ«ï¼‰');
    else if(sy3>=140||di3>=90) al.push('è¡€åœ§ '+bpRaw2+'mmHgï¼ˆé«˜è¡€åœ§ãƒ»è¦æ³¨æ„ï¼‰');
    else if(sy3<90||di3<60) al.push('è¡€åœ§ '+bpRaw2+'mmHgï¼ˆä½è¡€åœ§ï¼‰');
  }
  if(pv2 > 100) al.push('è„ˆæ‹ '+pv2+'å›/åˆ†ï¼ˆé »è„ˆï¼‰');
  else if(pv2 > 0 && pv2 < 50) al.push('è„ˆæ‹ '+pv2+'å›/åˆ†ï¼ˆå¾è„ˆï¼‰');
  if(sv > 0 && sv < 95) al.push('SpO2 '+sv+'%ï¼ˆä½ä¸‹ã«æ³¨æ„ï¼‰');

  var entry = {
    id      : Date.now(),
    datetime: gv('f-dt') || new Date().toISOString().slice(0,16),
    name    : gv('f-name') || 'ï¼ˆä¸æ˜ï¼‰',
    staff   : gv('f-staff') || 'ï¼ˆä¸æ˜ï¼‰',
    service : gv('f-svc'),
    temp    : gv('f-temp'), bp: gv('f-bp'), pulse: gv('f-pulse'), spo2: gv('f-spo2'),
    meal    : gv('f-meal'), water: gv('f-water'),
    bath    : gv('f-bath'), toilet: gv('f-toilet'),
    walk    : gv('f-walk'), mood: gv('f-mood'), note: gv('f-note'),
    record  : rec,
    alerts  : al
  };

  DB.unshift(entry);
  localStorage.setItem('careDB', JSON.stringify(DB));

  if(entry.staff && entry.staff !== 'ï¼ˆä¸æ˜ï¼‰'){
    document.getElementById('login-name').textContent = entry.staff;
  }

  // ãƒã‚¤ã‚¿ãƒ«è­¦å‘ŠéŸ³ï¼ˆè¨­å®šãŒONã®ã¨ãã®ã¿ï¼‰
  if(APP_SETTINGS.alertSound && entry.alerts && entry.alerts.length > 0){
    try{
      var ac = new (window.AudioContext || window.webkitAudioContext)();
      var osc = ac.createOscillator();
      var gain = ac.createGain();
      osc.connect(gain); gain.connect(ac.destination);
      osc.frequency.value = 880;
      gain.gain.setValueAtTime(0.4, ac.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.6);
      osc.start(); osc.stop(ac.currentTime + 0.6);
    } catch(e){}
  }

  toast('ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼'+(entry.alerts&&entry.alerts.length?' âš ï¸ã‚¢ãƒ©ãƒ¼ãƒˆã‚ã‚Š':''));
  updDash();
  renderList();

  // ä¿å­˜å¾Œè‡ªå‹•ã‚¯ãƒªã‚¢ï¼ˆè¨­å®šãŒONã®ã¨ãï¼‰
  if(APP_SETTINGS.autoClear){
    setTimeout(function(){ clearOut(); }, 800);
  }

  // ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ï¼ˆGASï¼‰
  var gasUrl = APP_SETTINGS.gasEndpoint || GAS_ENDPOINT;
  if(gasUrl){
    fetch(gasUrl, {method:'POST', body:JSON.stringify(entry)})
      .then(function(){ toast('â˜ï¸ Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚‚ä¿å­˜ã•ã‚Œã¾ã—ãŸ'); })
      .catch(function(){ toast('âš ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ã«å¤±æ•—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã«ã¯ä¿å­˜æ¸ˆã¿ï¼‰'); });
  }
}

// ===== ä¸€è¦§ =====
function renderList(){
  var kw  = (document.getElementById('fs').value||'').toLowerCase();
  var svc = document.getElementById('fsvc').value;
  var d1  = document.getElementById('fd1').value;
  var d2  = document.getElementById('fd2').value;

  // ã‚¹ã‚¿ãƒƒãƒ•ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°
  var fstSel = document.getElementById('fst');
  var fstCur = fstSel.value;
  var staffs = [];
  DB.forEach(function(r){ if(r.staff && staffs.indexOf(r.staff)<0) staffs.push(r.staff); });
  fstSel.innerHTML = '<option value="">å…¨ã‚¹ã‚¿ãƒƒãƒ•</option>' + staffs.map(function(s){
    return '<option'+(s===fstCur?' selected':'')+'>'+s+'</option>';
  }).join('');
  var st = fstSel.value;

  var rows = DB.filter(function(r){
    if(kw  && !r.name.toLowerCase().includes(kw) && !(r.record||'').toLowerCase().includes(kw)) return false;
    if(st  && r.staff   !== st)  return false;
    if(svc && r.service !== svc) return false;
    if(d1  && r.datetime.slice(0,10) < d1) return false;
    if(d2  && r.datetime.slice(0,10) > d2) return false;
    return true;
  });

  document.getElementById('list-cnt').textContent = rows.length+'ä»¶è¡¨ç¤º / å…¨'+DB.length+'ä»¶';

  var tbody = document.getElementById('list-body');
  if(!rows.length){
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:28px;color:#94a3b8;">è©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
    return;
  }
  tbody.innerHTML = rows.map(function(r){
    var dt  = new Date(r.datetime);
    var ds  = (dt.getMonth()+1)+'/'+dt.getDate()+' '+String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0');
    var abl = r.alerts&&r.alerts.length ? ' <span class="tag trd">âš è¦ç¢ºèª</span>' : '';
    var moodtag = r.mood ? '<span class="tag tbl">'+r.mood+'</span>' : 'â€”';
    return '<tr>' +
      '<td style="white-space:nowrap">'+ds+'</td>' +
      '<td><strong>'+r.name+'</strong></td>' +
      '<td>'+r.staff+'</td>' +
      '<td><span class="tag tgr">'+(r.service||'â€”')+'</span></td>' +
      '<td style="font-size:11px;white-space:nowrap">'+[r.temp?r.temp+'â„ƒ':'', r.bp||''].filter(Boolean).join(' / ')+(abl||'â€”'.replace('â€”',''))+'</td>' +
      '<td>'+(r.meal||'â€”')+'</td>' +
      '<td>'+moodtag+'</td>' +
      '<td style="white-space:nowrap">' +
        '<button class="btn bo" style="padding:5px 10px;font-size:11px;" onclick="showDetail('+r.id+')">è©³ç´°</button>' +
        '<button class="btn bg" style="padding:5px 10px;font-size:11px;margin-left:4px;" onclick="delRec('+r.id+')">å‰Šé™¤</button>' +
      '</td></tr>';
  }).join('');
}

function clearF(){
  ['fs','fd1','fd2'].forEach(function(id){ document.getElementById(id).value=''; });
  ['fst','fsvc'].forEach(function(id){ document.getElementById(id).value=''; });
  renderList();
}
function delRec(id){
  if(!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  DB = DB.filter(function(r){ return r.id!==id; });
  localStorage.setItem('careDB', JSON.stringify(DB));
  renderList(); updDash();
  toast('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ');
}
function exportCSV(){
  var hd = ['æ—¥æ™‚','åˆ©ç”¨è€…å','æ‹…å½“','ã‚µãƒ¼ãƒ“ã‚¹','ä½“æ¸©','è¡€åœ§','è„ˆæ‹','SpO2','é£Ÿäº‹','æ°´åˆ†','å…¥æµ´','æ’æ³„','ç§»å‹•','æ§˜å­','ç‰¹è¨˜','ã‚¢ãƒ©ãƒ¼ãƒˆ'];
  var rows = DB.map(function(r){ return [r.datetime,r.name,r.staff,r.service,r.temp,r.bp,r.pulse,r.spo2,r.meal,r.water,r.bath,r.toilet,r.walk,r.mood,r.note,(r.alerts||[]).join('|')]; });
  var csv = '\uFEFF' + [hd].concat(rows).map(function(r){ return r.map(function(v){ return '"'+((v||'').toString().replace(/"/g,'""'))+'"'; }).join(','); }).join('\n');
  var a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = 'ä»‹è­·è¨˜éŒ²_'+new Date().toISOString().slice(0,10)+'.csv';
  a.click();
  toast('ğŸ“¥ CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
}

// ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====
// ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æœŸé–“ç®¡ç† =====
var dashPeriod = 'month'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šä»Šæœˆ

function setDashPeriod(period, el){
  dashPeriod = period;
  document.querySelectorAll('[id^="dp-"]').forEach(function(b){
    if(b.tagName==='BUTTON'){ b.style.background=''; b.style.color=''; b.className='btn bg'; }
  });
  if(el){ el.style.background='var(--blue)'; el.style.color='#fff'; }
  var customRange = document.getElementById('dp-custom-range');
  if(period === 'custom'){
    customRange.style.display = 'flex';
  } else {
    customRange.style.display = 'none';
  }
  updDash();
}

function getDashRange(){
  var now = new Date();
  var today = now.toISOString().slice(0,10);
  var from = '', to = today;
  if(dashPeriod === 'today'){
    from = today;
    document.getElementById('dp-period-label') && (document.getElementById('st-period-label').textContent='ä»Šæ—¥');
  } else if(dashPeriod === 'week'){
    var d = new Date(now); d.setDate(d.getDate() - d.getDay());
    from = d.toISOString().slice(0,10);
    document.getElementById('st-period-label') && (document.getElementById('st-period-label').textContent='ä»Šé€±');
  } else if(dashPeriod === 'month'){
    from = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-01';
    document.getElementById('st-period-label') && (document.getElementById('st-period-label').textContent='ä»Šæœˆ');
  } else if(dashPeriod === 'all'){
    from = '2000-01-01';
    document.getElementById('st-period-label') && (document.getElementById('st-period-label').textContent='å…¨æœŸé–“');
  } else if(dashPeriod === 'custom'){
    from = document.getElementById('dp-from').value || '2000-01-01';
    to   = document.getElementById('dp-to').value   || today;
    var label = (from||'â€”')+' ã€œ '+(to||'â€”');
    document.getElementById('st-period-label') && (document.getElementById('st-period-label').textContent=label);
    document.getElementById('dp-label') && (document.getElementById('dp-label').textContent=label);
  }
  return {from: from, to: to};
}

function updDash(){
  var today = new Date().toISOString().slice(0,10);
  document.getElementById('st-date').textContent = today;

  // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
  var range = getDashRange();
  var filteredDB = DB.filter(function(r){
    var d = r.datetime.slice(0,10);
    return d >= range.from && d <= range.to;
  });

  document.getElementById('st-total').textContent = filteredDB.length;
  document.getElementById('st-today').textContent = DB.filter(function(r){ return r.datetime.slice(0,10)===today; }).length;
  document.getElementById('st-users').textContent = (function(){ var s={}; filteredDB.forEach(function(r){ s[r.name]=1; }); return Object.keys(s).length; })();
  var alrts = filteredDB.filter(function(r){ return r.alerts&&r.alerts.length; });
  document.getElementById('st-alrt').textContent = alrts.length;

  var total = filteredDB.length || 1;

  // åˆ©ç”¨è€…åˆ¥
  var um = {};
  filteredDB.forEach(function(r){ um[r.name]=(um[r.name]||0)+1; });
  var uel = document.getElementById('db-users');
  if(!Object.keys(um).length){ uel.innerHTML='<div class="out-empty">æœŸé–“å†…ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'; }
  else uel.innerHTML = Object.entries(um).sort(function(a,b){ return b[1]-a[1]; }).map(function(arr){
    var n=arr[0],c=arr[1];
    return '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">' +
      '<span style="min-width:90px;font-size:12px;font-weight:600;">'+n+'</span>' +
      '<div style="flex:1;background:#e2e8f0;border-radius:20px;height:9px;">' +
      '<div style="background:var(--blue);border-radius:20px;height:9px;width:'+Math.min(c/total*100,100)+'%"></div></div>' +
      '<span style="font-size:12px;color:var(--gray);">'+c+'ä»¶</span></div>';
  }).join('');

  // æ‹…å½“è€…åˆ¥
  var sm = {};
  filteredDB.forEach(function(r){ if(r.staff) sm[r.staff]=(sm[r.staff]||0)+1; });
  var sel2 = document.getElementById('db-staff');
  if(!Object.keys(sm).length){ sel2.innerHTML='<div class="out-empty">æœŸé–“å†…ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'; }
  else sel2.innerHTML = Object.entries(sm).sort(function(a,b){ return b[1]-a[1]; }).map(function(arr){
    var n=arr[0],c=arr[1];
    return '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">' +
      '<span style="min-width:90px;font-size:12px;font-weight:600;">ğŸ‘¤ '+n+'</span>' +
      '<div style="flex:1;background:#e2e8f0;border-radius:20px;height:9px;">' +
      '<div style="background:var(--green);border-radius:20px;height:9px;width:'+Math.min(c/total*100,100)+'%"></div></div>' +
      '<span style="font-size:12px;color:var(--gray);">'+c+'ä»¶</span></div>';
  }).join('');

  // ã‚¢ãƒ©ãƒ¼ãƒˆ
  var ael = document.getElementById('db-alrt');
  if(!alrts.length){ ael.innerHTML='<div class="out-empty">æœŸé–“å†…ã«ç•°å¸¸å€¤ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ âœ…</div>'; }
  else ael.innerHTML = alrts.slice(0,8).map(function(r){
    return '<div style="padding:10px;background:var(--redbg);border-radius:8px;margin-bottom:8px;font-size:12px;">' +
      '<strong>'+r.name+'</strong>ã€€<span style="color:#94a3b8;">'+r.datetime.slice(5,16).replace('T',' ')+'</span>' +
      r.alerts.map(function(a){ return '<br><span style="color:var(--red);">âš  '+a+'</span>'; }).join('') +
      '</div>';
  }).join('');

  // é£Ÿäº‹
  var mel = document.getElementById('db-meal');
  var mr  = filteredDB.filter(function(r){ return r.meal; }).slice(0,8);
  if(!mr.length){ mel.innerHTML='<div class="out-empty">æœŸé–“å†…ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'; }
  else mel.innerHTML = mr.map(function(r){
    return '<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px;">' +
      '<strong>'+r.name+'</strong><span style="color:#475569;">'+r.meal+'</span></div>';
  }).join('');

  // æ§˜å­
  var ool = document.getElementById('db-mood');
  var or2 = filteredDB.filter(function(r){ return r.mood; }).slice(0,8);
  if(!or2.length){ ool.innerHTML='<div class="out-empty">æœŸé–“å†…ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'; }
  else ool.innerHTML = or2.map(function(r){
    var tc = r.mood.includes('è‰¯å¥½')||r.mood.includes('ç©ã‚„ã‹') ? 'tgr' : r.mood.includes('ä¸ç©')||r.mood.includes('å…ƒæ°—ãŒãªã„') ? 'tyl' : 'tbl';
    return '<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px;">' +
      '<strong>'+r.name+'</strong><span class="tag '+tc+'">'+r.mood+'</span></div>';
  }).join('');
}

// ===== ãƒ¢ãƒ¼ãƒ€ãƒ« =====
function showDetail(id){
  var r = DB.find(function(r){ return r.id===id; });
  if(!r) return;
  document.getElementById('m-title').textContent = 'ğŸ“„ '+r.name+'ã€€'+r.datetime.slice(5,16).replace('T',' ');
  document.getElementById('m-body').textContent  = r.record;
  document.getElementById('modal').classList.add('on');
}
function closeModal(e){
  if(e.target === document.getElementById('modal')) document.getElementById('modal').classList.remove('on');
}
function copyModal(){
  var t = document.getElementById('m-body').textContent;
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(t).then(function(){ toast('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); });
  } else {
    var ta = document.createElement('textarea');
    ta.value = t;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    toast('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  }
}

// ===== ãƒˆãƒ¼ã‚¹ãƒˆ =====
function toast(msg){
  var el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('on');
  setTimeout(function(){ el.classList.remove('on'); }, 2800);
}

// ===== åˆæœŸåŒ– =====
window.onload = function(){
  // æ—¥æ™‚ã‚»ãƒƒãƒˆ
  var now   = new Date();
  var local = new Date(now.getTime() - now.getTimezoneOffset()*60000);
  document.getElementById('f-dt').value = local.toISOString().slice(0,16);
  document.getElementById('st-date').textContent = now.toISOString().slice(0,10);

  // è¨­å®šé©ç”¨
  applySettings();

  // ã‚¹ã‚¿ãƒƒãƒ•ã‚»ãƒ¬ã‚¯ãƒˆåˆæœŸåŒ–
  refreshStaffSelect();
  renderLoginStaffList();

  // sessionStorageã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãªã‘ã‚Œã°å¿…ãšãƒ­ãƒƒã‚¯ç”»é¢ã‚’è¡¨ç¤º
  if(!currentLoginStaff){
    document.getElementById('pin-screen').style.display = 'flex';
  } else {
    document.getElementById('login-name').textContent = currentLoginStaff;
    var isAdminNow = isAdmin(currentLoginStaff);
    var settingsBtn2  = document.getElementById('nav-settings-btn');
    var staffNavBtn2  = document.getElementById('nav-staff-btn');
    var staffEditBtn2 = document.getElementById('staff-edit-btn');
    if(settingsBtn2)  settingsBtn2.style.display  = isAdminNow ? '' : 'none';
    if(staffNavBtn2)  staffNavBtn2.style.display  = isAdminNow ? '' : 'none';
    if(staffEditBtn2) staffEditBtn2.style.display = isAdminNow ? '' : 'none';
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹åæ˜ 
    if(APP_SETTINGS.defaultService){
      var svcSel3 = document.getElementById('f-svc');
      if(svcSel3) svcSel3.value = APP_SETTINGS.defaultService;
    }
    // è‡ªå‹•ãƒ­ãƒƒã‚¯ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
    resetAutoLockTimer();
  }

  // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
  if(DB.length === 0){
    DB = [
      {id:1,datetime:'2026-02-26T09:30',name:'å±±ç”° èŠ±å­',staff:'éˆ´æœ¨ æµ',service:'ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹',temp:'36.5',bp:'125/78',pulse:'74',spo2:'98',meal:'å…¨é‡æ‘‚å–',water:'ååˆ†æ‘‚å–',bath:'è‡ªç«‹å…¥æµ´ï¼ˆå•é¡Œãªã—ï¼‰',toilet:'è‡ªç«‹æ’æ³„ï¼ˆå•é¡Œãªã—ï¼‰',walk:'è‡ªç«‹æ­©è¡Œï¼ˆå•é¡Œãªã—ï¼‰',mood:'ç¬‘é¡”ãŒã‚ã‚Šè‰¯å¥½',note:'å®¶æ—ã‹ã‚‰é›»è©±ã‚ã‚Šã€‚é€±æœ«ã®å¤–å‡ºã‚’æ¥½ã—ã¿ã«ã—ã¦ã„ã‚‹æ§˜å­ã€‚',record:'ã€ä»‹è­·æ—¥å¸¸è¨˜éŒ²ã€‘\nè¨˜éŒ²æ—¥æ™‚ï¼š2026å¹´2æœˆ26æ—¥ 09:30\nåˆ©ç”¨è€…åï¼šå±±ç”° èŠ±å­\næ‹…å½“è·å“¡ï¼šéˆ´æœ¨ æµ\n\nâ–  ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³\nä½“æ¸© 36.5â„ƒã€€/ã€€è¡€åœ§ 125/78mmHgã€€/ã€€è„ˆæ‹ 74å›/åˆ†ã€€/ã€€SpO2 98%\n\nâ–  æ—¥å¸¸ã‚±ã‚¢è¨˜éŒ²\nãƒ»é£Ÿäº‹ï¼šå…¨é‡æ‘‚å–\nãƒ»æ°´åˆ†ï¼šååˆ†æ‘‚å–\nãƒ»å…¥æµ´ï¼šè‡ªç«‹å…¥æµ´ï¼ˆå•é¡Œãªã—ï¼‰\nãƒ»æ’æ³„ï¼šè‡ªç«‹æ’æ³„ï¼ˆå•é¡Œãªã—ï¼‰\nãƒ»æ§˜å­ï¼šç¬‘é¡”ãŒã‚ã‚Šè‰¯å¥½',alerts:[]},
      {id:2,datetime:'2026-02-26T10:15',name:'ä½è—¤ æ¬¡éƒ',staff:'ç”°ä¸­ ç¾å’²',service:'ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹',temp:'37.8',bp:'145/92',pulse:'92',spo2:'96',meal:'å°‘é‡æ‘‚å–',water:'å°‘é‡æ‘‚å–',bath:'æ¸…æ‹­å®Ÿæ–½',toilet:'ã‚ªãƒ ãƒ„äº¤æ›å®Ÿæ–½',walk:'è»Šæ¤…å­ã«ã¦ç§»å‹•',mood:'ã‚„ã‚„å…ƒæ°—ãŒãªã„æ§˜å­',note:'æœã‹ã‚‰é£Ÿæ¬²ä½ä¸‹ã‚ã‚Šã€‚çµŒéè¦³å¯ŸãŒå¿…è¦ã€‚',record:'ã€ä»‹è­·æ—¥å¸¸è¨˜éŒ²ã€‘\nè¨˜éŒ²æ—¥æ™‚ï¼š2026å¹´2æœˆ26æ—¥ 10:15\nåˆ©ç”¨è€…åï¼šä½è—¤ æ¬¡éƒ\næ‹…å½“è·å“¡ï¼šç”°ä¸­ ç¾å’²\n\nâ–  ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³\nä½“æ¸© 37.8â„ƒã€€/ã€€è¡€åœ§ 145/92mmHgã€€/ã€€è„ˆæ‹ 92å›/åˆ†\n\nâš ï¸ è¦æ³¨æ„äº‹é …\nâš  ä½“æ¸© 37.8â„ƒï¼ˆç™ºç†±ã®å¯èƒ½æ€§ï¼‰\nâš  è¡€åœ§ 145/92mmHgï¼ˆé«˜è¡€åœ§ãƒ»è¦æ³¨æ„ï¼‰\n\nâ–  æ—¥å¸¸ã‚±ã‚¢è¨˜éŒ²\nãƒ»é£Ÿäº‹ï¼šå°‘é‡æ‘‚å–\nãƒ»å…¥æµ´ï¼šæ¸…æ‹­å®Ÿæ–½\nãƒ»æ’æ³„ï¼šã‚ªãƒ ãƒ„äº¤æ›å®Ÿæ–½\nãƒ»æ§˜å­ï¼šã‚„ã‚„å…ƒæ°—ãŒãªã„æ§˜å­',alerts:['ä½“æ¸© 37.8â„ƒï¼ˆç™ºç†±ã®å¯èƒ½æ€§ï¼‰','è¡€åœ§ 145/92mmHgï¼ˆé«˜è¡€åœ§ãƒ»è¦æ³¨æ„ï¼‰']},
      {id:3,datetime:'2026-02-25T14:00',name:'ç”°ä¸­ å¹¸å­',staff:'éˆ´æœ¨ æµ',service:'è¨ªå•ä»‹è­·',temp:'36.2',bp:'118/70',pulse:'68',spo2:'99',meal:'å…¨é‡æ‘‚å–',water:'ååˆ†æ‘‚å–',bath:'ã‚·ãƒ£ãƒ¯ãƒ¼æµ´å®Ÿæ–½',toilet:'è‡ªç«‹æ’æ³„ï¼ˆå•é¡Œãªã—ï¼‰',walk:'æ­©è¡Œå™¨ä½¿ç”¨ã«ã¦ç§»å‹•',mood:'ç©ã‚„ã‹ãƒ»è½ã¡ç€ã„ã¦ã„ã‚‹',note:'ç‰¹ã«å•é¡Œãªã—ã€‚è¶£å‘³ã®ç·¨ã¿ç‰©ã‚’æ¥½ã—ã‚“ã§ã„ãŸã€‚',record:'ã€ä»‹è­·æ—¥å¸¸è¨˜éŒ²ã€‘\nè¨˜éŒ²æ—¥æ™‚ï¼š2026å¹´2æœˆ25æ—¥ 14:00\nåˆ©ç”¨è€…åï¼šç”°ä¸­ å¹¸å­\næ‹…å½“è·å“¡ï¼šéˆ´æœ¨ æµ\n\nâ–  ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³\nä½“æ¸© 36.2â„ƒã€€/ã€€è¡€åœ§ 118/70mmHgã€€/ã€€è„ˆæ‹ 68å›/åˆ†\n\nâ–  æ—¥å¸¸ã‚±ã‚¢è¨˜éŒ²\nãƒ»é£Ÿäº‹ï¼šå…¨é‡æ‘‚å–\nãƒ»æ°´åˆ†ï¼šååˆ†æ‘‚å–\nãƒ»å…¥æµ´ï¼šã‚·ãƒ£ãƒ¯ãƒ¼æµ´å®Ÿæ–½\nãƒ»æ§˜å­ï¼šç©ã‚„ã‹ãƒ»è½ã¡ç€ã„ã¦ã„ã‚‹',alerts:[]},
      {id:4,datetime:'2026-02-25T11:00',name:'å±±ç”° èŠ±å­',staff:'ä½è—¤ å¥',service:'ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹',temp:'36.7',bp:'128/80',pulse:'76',spo2:'97',meal:'8å‰²ç¨‹åº¦æ‘‚å–',water:'ååˆ†æ‘‚å–',bath:'å…¥æµ´ä»‹åŠ©å®Ÿæ–½ï¼ˆå•é¡Œãªã—ï¼‰',toilet:'ä¸€éƒ¨ä»‹åŠ©ã«ã¦æ’æ³„',walk:'æ­©è¡Œå™¨ä½¿ç”¨ã«ã¦ç§»å‹•',mood:'ç©ã‚„ã‹ãƒ»è½ã¡ç€ã„ã¦ã„ã‚‹',note:'æ˜¨æ—¥ã‚ˆã‚Šé£Ÿæ¬²å›å¾©å‚¾å‘ã€‚',record:'ã€ä»‹è­·æ—¥å¸¸è¨˜éŒ²ã€‘\nè¨˜éŒ²æ—¥æ™‚ï¼š2026å¹´2æœˆ25æ—¥ 11:00\nåˆ©ç”¨è€…åï¼šå±±ç”° èŠ±å­\næ‹…å½“è·å“¡ï¼šä½è—¤ å¥',alerts:[]},
    ];
    localStorage.setItem('careDB', JSON.stringify(DB));
  }
  updDash();
  renderList();
};
</script>
</body>
</html>
